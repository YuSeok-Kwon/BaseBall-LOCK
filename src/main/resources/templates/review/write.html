<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/reviewDefault}">

<th:block layout:fragment="contents">
<div class="container my-5 rounded p-4"
     th:style="'max-width: 1200px; background-color: #fff; border: 2px solid ' + ${teamColor}">

  <!-- ë©”ì¸ ê²½ê¸° ë°•ìŠ¤ -->
  <div class="bg-warning-subtle rounded text-center py-4 px-2 mb-4 shadow-sm"
  	   th:style="'background-color: #fff; border: 2px solid ' + ${teamColor}">
    		    <div class="fs-3 mb-4 d-flex justify-content-center align-items-center text-center" style="width: 100%;">
			<!-- ì›ì •íŒ€ -->
			<div class="d-flex align-items-center justify-content-end gap-2" style="flex: 1;">
			  <img th:src="@{/static/emblems/{logo}.svg(logo=${game.awayTeamLogo})}" class="table-team-logo mb-1 me-2">  
			  <span th:if="${game.awayScore > game.homeScore}" th:text="${game.awayTeamName}" class="fs-2 fw-bold">ê¸°ì•„ íƒ€ì´ê±°ì¦ˆ</span>
			  <span th:unless="${game.awayScore > game.homeScore}" th:text="${game.awayTeamName}" class="fs-2">ê¸°ì•„ íƒ€ì´ê±°ì¦ˆ</span>
			
			  <span th:if="${game.awayScore > game.homeScore}" th:text="${game.awayScore}" class="fs-2 fw-bold text-dark">3</span>
			  <span th:unless="${game.awayScore > game.homeScore}" th:text="${game.awayScore}" class="fs-2 text-dark">3</span>
			</div>
			
			<!-- VS -->
			<div style="flex: 0 0 100px;">
			  <span class="text-secondary fs-3">VS</span>
			</div>
			
			<!-- í™ˆíŒ€ -->
			<div class="d-flex align-items-center justify-content-start gap-2" style="flex: 1;">
			  <span th:if="${game.homeScore > game.awayScore}" th:text="${game.homeScore}" class="fs-2 fw-bold text-dark">6</span>
			  <span th:unless="${game.homeScore > game.awayScore}" th:text="${game.homeScore}" class="fs-2 text-dark">6</span>
			
			  <span th:if="${game.homeScore > game.awayScore}" th:text="${game.homeTeamName + ' (í™ˆ)'}" class="fs-2 fw-bold">ë¡¯ë° ìì´ì–¸ì¸  (í™ˆ)</span>
			  <span th:unless="${game.homeScore > game.awayScore}" th:text="${game.homeTeamName + ' (í™ˆ)'}" class="fs-2">ë¡¯ë° ìì´ì–¸ì¸  (í™ˆ)</span>
			
			  <img th:src="@{/static/emblems/{logo}.svg(logo=${game.homeTeamLogo})}" class="table-team-logo mb-1 me-2">
			</div>
		</div>
	
	    <!-- ì´ë‹ë³„ ì ìˆ˜ í…Œì´ë¸” -->
	    <div class="table-responsive">
	      <table class="table table-bordered text-center bg-white fs-5"
			     style="table-layout: fixed; width: 100%;">
			<thead class="table-light fs-5">
			  <tr style="background-color: #fff3cd;">
			   <th style="width: 180px;" class="bg-light">íŒ€</th>
			   <th th:each="i : ${#numbers.sequence(1, 9)}" style="width: 60px;" th:text="${i}">1</th>
			   <th style="width: 70px;">R</th>
			   <th style="width: 70px;">H</th>
			   <th style="width: 70px;">E</th>
			  </tr>
			</thead>
			<tbody>
			  <tr style="background-color: #f3f6f9;">
			     <th class="fs-5 text-white"
					 th:style="'background-color:' + ${game.awayTeamColor}"
					 th:text="${game.awayTeamName}">ê¸°ì•„</th>
			   <td th:each="score : ${game.awayInningScores}" th:text="${score}" style="width: 60px;">0</td>
			   <td style="width: 70px;" th:text="${game.awayScore}">3</td>
			   <td style="width: 70px;" th:text="${game.awayHits}">7</td>
			   <td style="width: 70px;" th:text="${game.awayErrors}">0</td>
			 </tr>
			 <tr style="background-color: #f3f6f9;">
			  <th class="fs-5 text-white"
    		      th:style="'background-color:' + ${game.homeTeamColor}"
    			  th:text="${game.homeTeamName + ' (í™ˆ)'}">ë¡¯ë°</th>
			   <td th:each="score : ${game.homeInningScores}" th:text="${score}" style="width: 60px;">0</td>
			   <td style="width: 70px;" th:text="${game.homeScore}">6</td>
			   <td style="width: 70px;" th:text="${game.homeHits}">9</td>
			   <td style="width: 70px;" th:text="${game.homeErrors}">1</td>
			 </tr>
		  </tbody>
		</table>
	  </div>
	  <div class="text-start small mt-2 ms-2">
	    <span th:if="${game.winPitcher != null}"><b>ìŠ¹ë¦¬íˆ¬ìˆ˜ : </b><span th:text="${game.winPitcher}" class="me-2">ê¶Œìœ ì„</span></span>
	    <span th:if="${game.holdPitchers != null and !game.holdPitchers.isEmpty()}">
	    	<b>í™€ë“œ : </b><span th:each="name, stat : ${game.holdPitchers}" th:text="${name}" class="me-2"></span>
		</span>
  		<span th:if="${game.savePitcher != null}"><b>ì„¸ì´ë¸Œ : </b><span th:text="${game.savePitcher}" class="me-2">ê¹€ì„±ì€</span></span><br>
  		<span th:if="${game.losePitcher != null}"><b>íŒ¨ì „íˆ¬ìˆ˜ : </b><span th:text="${game.losePitcher}" class="me-2">ê¶Œì„ìœ </span></span>
	  </div>
  </div>

  <!-- ë¦¬ë·° ì‘ì„± í¼ -->
<form th:action="@{/review/save}" method="post" onsubmit="return false;">
  <input type="hidden" name="scheduleId" th:value="${scheduleInfo.id}" />
  <input type="hidden" name="id" th:value="${review.id}" />

  <!-- ë¦¬ë·° ìš”ì•½ -->
  <div class="mb-3">
    <label class="form-label">ì˜¤ëŠ˜ ê²½ê¸° ë¦¬ë·°</label>
    <textarea rows="5"
              class="form-control"
              name="summary"
              required maxlength="100"
              th:text="${review.summary}"> </textarea>
  </div>

  <!-- BEST ì„ ìˆ˜ -->
  <div class="mb-3">
    <label class="form-label">ì˜¤ëŠ˜ì˜ BEST ì„ ìˆ˜</label>
    <input type="text"
           class="form-control"
           name="bestPlayer"
           required maxlength="50"
           th:value="${review.bestPlayer}" />
  </div>

  <!-- WORST ì„ ìˆ˜ -->
  <div class="mb-3">
    <label class="form-label">ì˜¤ëŠ˜ì˜ WORST ì„ ìˆ˜</label>
    <input type="text"
           class="form-control"
           name="worstPlayer"
           required maxlength="50"
           th:value="${review.worstPlayer}" />
  </div>

  <!-- ê°ì • ì„ íƒ -->
  <div class="mb-3">
    <label class="form-label">ì˜¤ëŠ˜ì˜ ê°ì •</label>
    <div id="feelingList" class="mb-3 d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-primary" data-value="ê¸°ì¨">ê¸°ì¨</button>
      <button type="button" class="btn btn-outline-primary" data-value="ì•„ì‰¬ì›€">ì•„ì‰¬ì›€</button>
      <button type="button" class="btn btn-outline-primary" data-value="í™”ë‚¨">í™”ë‚¨</button>
      <button type="button" class="btn btn-outline-primary" data-value="ìŠ¬í””">ìŠ¬í””</button>
      <button type="button" class="btn btn-outline-primary" data-value="ì§œì¦">ì§œì¦</button>
      <button type="button" class="btn btn-outline-primary" data-value="ì„¤ë ˜">ì„¤ë ˜</button>
      <button type="button" class="btn btn-outline-primary" data-value="ë§Œì¡±">ë§Œì¡±</button>
      <button type="button" class="btn btn-outline-primary" data-value="ì‹¤ë§">ì‹¤ë§</button>
      <button type="button" class="btn btn-outline-primary" data-value="ê°ë™">ê°ë™</button>
      <button type="button" class="btn btn-outline-primary" data-value="í—ˆíƒˆ">í—ˆíƒˆ</button>
      <button type="button" class="btn btn-outline-primary" data-value="ì—´ì •">ì—´ì •</button>
    </div>
    <div id="selectedFeelings" class="d-flex flex-wrap gap-2"></div>
    <input type="hidden" id="feelingsInput" name="feelings" th:value="${review.feelings}" />
  </div>

  <!-- ë³„ì  -->
  <div class="mb-3">
    <label class="form-label">ë³„ì </label>
    <div id="star-rating"
         class="d-flex justify-content-center mb-3"
         th:style="'font-size: 2rem; cursor: pointer; color:' + ${teamColor}">
      <span data-value="1">â˜†</span>
      <span data-value="2">â˜†</span>
      <span data-value="3">â˜†</span>
      <span data-value="4">â˜†</span>
      <span data-value="5">â˜†</span>
    </div>
    <input type="hidden" id="ratingInput" name="rating" th:value="${review.rating}" />
  </div>
</form>

	<div class="text-center">
	  <button type="button" id="saveReviewButton" class="btn" style="background-color: #FACC15;">ë“±ë¡</button>
	  <a href="/review-view" class="btn ms-2" style="background-color: #e2e6ea; color: black;">ì·¨ì†Œ</a>
	</div>
  
</div>
</th:block>

<th:block layout:fragment="script">
<script>
document.addEventListener('DOMContentLoaded', function() {
    var teamColor = "[[${teamColor}]]" || '#000000';

    var feelingList = document.getElementById('feelingList');
    var selectedFeelings = document.getElementById('selectedFeelings');
    var hiddenFeelingsInput = document.getElementById('feelingsInput');
    var selected = new Set();

    // â¬‡ï¸ ì´ˆê¸° ê°ì • ê°’ ë°˜ì˜
    var initialFeelings = hiddenFeelingsInput.value ? hiddenFeelingsInput.value.split(',') : [];
    initialFeelings.forEach(function(value) {
        selected.add(value.trim());
    });

    function createBadge(value) {
        var badge = document.createElement('span');
        badge.className = 'badge d-flex align-items-center';
        badge.style.backgroundColor = teamColor;
        badge.style.color = 'white';
        badge.style.gap = '5px';
        badge.innerHTML = value + '<button type="button" class="btn-close btn-close-white btn-sm" data-value="' + value + '"></button>';
        return badge;
    }

    function updateSelectedFeelings() {
        selectedFeelings.innerHTML = '';

        selected.forEach(function(value) {
            var badge = createBadge(value);
            selectedFeelings.appendChild(badge);
        });

        hiddenFeelingsInput.value = Array.from(selected).join(',');

        var closeButtons = selectedFeelings.querySelectorAll('.btn-close');
        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var value = btn.getAttribute('data-value');
                selected.delete(value);
                updateSelectedFeelings();

                var feelingButton = feelingList.querySelector('button[data-value="' + value + '"]');
                if (feelingButton) {
                    feelingButton.classList.remove('btn-primary');
                    feelingButton.classList.add('btn-outline-primary');
                    feelingButton.style.backgroundColor = 'white';
                    feelingButton.style.color = teamColor;
                }
            });
        });
    }

    var feelingButtons = feelingList.querySelectorAll('button');
    feelingButtons.forEach(function(button) {
        var value = button.getAttribute('data-value');

        // â¬‡ï¸ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
        if (selected.has(value)) {
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            button.style.backgroundColor = teamColor;
            button.style.color = 'white';
        } else {
            button.style.borderColor = teamColor;
            button.style.color = teamColor;
        }

        // í´ë¦­ ì´ë²¤íŠ¸
        button.addEventListener('click', function() {
            if (selected.has(value)) {
                selected.delete(value);
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
                button.style.backgroundColor = 'white';
                button.style.color = teamColor;
            } else {
                selected.add(value);
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
                button.style.backgroundColor = teamColor;
                button.style.color = 'white';
            }

            updateSelectedFeelings();
        });
    });

    updateSelectedFeelings();  // â¬…ï¸ ì´ˆê¸° ë±ƒì§€ ì¶œë ¥

    // â­ ë³„ì  ì´ˆê¸°í™”
    var stars = document.querySelectorAll('#star-rating span');
    var ratingInput = document.getElementById('ratingInput');
    var currentRating = parseInt(ratingInput.value) || 0;

    function updateStars(rating) {
        stars.forEach(function(star) {
            var value = parseInt(star.getAttribute('data-value'));
            star.textContent = (value <= rating) ? 'â˜…' : 'â˜†';
        });
        ratingInput.value = rating;
    }

    stars.forEach(function(star) {
        star.addEventListener('click', function() {
            var selectedValue = parseInt(star.getAttribute('data-value'));
            currentRating = (currentRating === selectedValue) ? selectedValue - 1 : selectedValue;
            updateStars(currentRating);
        });
    });

    updateStars(currentRating);  // â¬…ï¸ ì´ˆê¸° ë³„ì  ë°˜ì˜

    // ğŸ“ ë¦¬ë·° ì €ì¥
    $("#saveReviewButton").click(function() {
        event.preventDefault();

        var reviewData = {
            scheduleId: $("input[name='scheduleId']").val(),
            id: $("input[name='id']").val(),  // â† ìˆ˜ì • ë¦¬ë·°ì¼ ê²½ìš° í¬í•¨
            summary: $("textarea[name='summary']").val(),
            bestPlayer: $("input[name='bestPlayer']").val(),
            worstPlayer: $("input[name='worstPlayer']").val(),
            feelings: $("#feelingsInput").val(),
            rating: $("#ratingInput").val()
        };

        $.ajax({
            url: '/review/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(reviewData),
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    window.location.href = '/review/calendar-view';
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
});
</script>
</th:block>

</html>