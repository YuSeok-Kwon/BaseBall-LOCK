<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}">

<th:block layout:fragment="contents">
	<div class="container-fluid py-5 px-3">
	
	  <!-- ì‹œì¦Œ ì„ íƒ -->
	  <div class="d-flex align-items-center mb-4 mx-4">
	    <form class="d-flex align-items-center px-4">
	      <select id="season-select" class="form-select" name="season" style="width:120px;" onchange="changeSeason(this.value)">
	        <option value="2025">2025</option>
	        <option value="2024">2024</option>
	        <option value="2023">2023</option>
	        <option value="2022">2022</option>
	        <option value="2021">2021</option>
	        <option value="2020">2020</option>
	      </select>
		  <input type="hidden" id="current-sort" name="sort" value="TotalWAR">
		  <input type="hidden" id="current-direction" name="direction" value="DESC">
	    </form>
	  </div>
	
	  <!-- íŒ€ ìˆœìœ„, TOP ìŠ¤íƒ¯ ì˜ì—­ -->
	  <div class="row gy-4 mx-5">
	    <div class="col-lg-4">
	      <div class="card border-point shadow-sm p-3">
	        <h5 class="text-center fw-bold mb-3">KBO ë¦¬ê·¸ íŒ€ ìˆœìœ„</h5>
	        <div id="team-ranking-list"></div>
	      </div>
	    </div>
	    <div class="col-lg-8">
	      <div class="row gy-4">
	        <div class="col-md-6">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">íŒ€ íƒ€ì ìŠ¤íƒ¯ Top</h5>
	            <ul id="top-batter-list" class="list-group border"></ul>
	          </div>
	        </div>
	        <div class="col-md-6">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">íŒ€ íˆ¬ìˆ˜ ìŠ¤íƒ¯ Top</h5>
	            <ul id="top-pitcher-list" class="list-group border"></ul>
	          </div>
	        </div>
	        <div class="col-12">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">íŒ€ WAA ìŠ¤íƒ¯ Top</h5>
	            <ul id="top-waa-list" class="list-group border"></ul>
	          </div>
	        </div>
	      </div>
	    </div>
	  </div>
	
	  <!-- ìŠ¤íƒ¯ í…Œì´ë¸” -->
	  <div id="ranking-table-wrapper" class="mt-5 mx-5"></div>
	
	</div>
  </th:block>

  <th:block layout:fragment="script">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <!-- jQuery ì¶”ê°€!! -->
		<script>
		document.addEventListener('DOMContentLoaded', function() {
			  var season = document.getElementById('season-select').value;
			  changeSeason(season);
			});
		// ì‹œì¦Œ ë³€ê²½
		function changeSeason(season) {
			
		  var currentSort = document.querySelector('input[name="sort"]').value;
		  var currentDirection = document.querySelector('input[name="direction"]').value;
		
		  $.ajax({
		    url: '/ranking/teamranking-view-json',
		    method: 'GET',
		    data: {
		      season: season,
		      sort: currentSort,
		      direction: currentDirection
		    },
		    success: function(data) {
		    	console.log("ë°›ì€ ë°ì´í„°:", data);
		      // ì¹´ë“œë·° ë¶€ë¶„
		      document.getElementById('team-ranking-list').innerHTML = renderTeamRankingList(data.rankingList);
		      document.getElementById('top-batter-list').innerHTML = renderTopBatterList(data.topBatterStats, data.categoryNameMap);
		      document.getElementById('top-pitcher-list').innerHTML = renderTopPitcherList(data.topPitcherStats, data.categoryNameMap);
		      document.getElementById('top-waa-list').innerHTML = renderTopWaaList(data.topWaaStats);
		
		      // í…Œì´ë¸” ë¶€ë¶„
		      renderStatTable(data.statRankingList, data.headers, data.categoryNameMap, data.currentSort, data.sortDirection);
		
		      // hidden input ì—…ë°ì´íŠ¸
		      document.querySelector('input[name="sort"]').value = data.currentSort;
		      document.querySelector('input[name="direction"]').value = data.sortDirection;
		    },
		    error: function(xhr, status, error) {
		      console.error('ì‹œì¦Œ ë³€ê²½ ì‹¤íŒ¨:', error);
		    }
		  });
		}
		
		// í…Œì´ë¸” ì •ë ¬
		function sortTable(sortKey) {
		  var season = document.querySelector('select[name="season"]').value;
		  var currentSortInput = document.querySelector('input[name="sort"]');
		  var directionInput = document.querySelector('input[name="direction"]');
		
		  var currentSort = currentSortInput ? currentSortInput.value : 'TotalWAR';
		  var currentDirection = directionInput ? directionInput.value : 'DESC';
		
		  var newDirection = 'ASC';
		  if (currentSort.toUpperCase() === sortKey.toUpperCase() && currentDirection === 'ASC') {
		    newDirection = 'DESC';
		  }
		
		  $.ajax({
		    url: '/ranking/teamranking-view-json',
		    method: 'GET',
		    data: {
		      season: season,
		      sort: sortKey,
		      direction: newDirection
		    },
		    success: function(data) {
		      // ì¹´ë“œë·° ë¶€ë¶„
		      document.getElementById('team-ranking-list').innerHTML = renderTeamRankingList(data.rankingList);
		      document.getElementById('top-batter-list').innerHTML = renderTopBatterList(data.topBatterStats, data.categoryNameMap);
		      document.getElementById('top-pitcher-list').innerHTML = renderTopPitcherList(data.topPitcherStats, data.categoryNameMap);
		      document.getElementById('top-waa-list').innerHTML = renderTopWaaList(data.topWaaStats);
		
		      // í…Œì´ë¸” ë¶€ë¶„
		      renderStatTable(data.statRankingList, data.headers, data.categoryNameMap, data.currentSort, data.sortDirection);
		
		      // hidden input ì—…ë°ì´íŠ¸
		      if (currentSortInput) currentSortInput.value = sortKey;
		      if (directionInput) directionInput.value = newDirection;
		    },
		    error: function(xhr, status, error) {
		      console.error('ì •ë ¬ ì‹¤íŒ¨:', error);
		    }
		  });
		}
		function convertHeaderToField(header) {
			  var map = {
			    'TotalWAR': 'totalWar',
			    'BetterWAR': 'betterWar',
			    'OPS': 'ops',
			    'AVG': 'avg',
			    'HR': 'hr',
			    'SB': 'sb',
			    'PitcherWAR': 'pitcherWar',
			    'SO': 'so',
			    'ERA': 'era',
			    'WHIP': 'whip',
			    'BB': 'bb',
			    'íƒ€ê²©': 'battingWaa',
			    'ì£¼ë£¨': 'baserunningWaa',
			    'ìˆ˜ë¹„': 'defenseWaa',
			    'ì„ ë°œ': 'startingWaa',
			    'ë¶ˆíœ': 'bullpenWaa'
			  };
			  return map[header] || header;
			}
		function formatValue(header, value) {
			  if (value === undefined || value === null || value === '-') {
			    return '-';
			  }
		
			  // OPS, AVG â†’ ì†Œìˆ˜ì  3ìë¦¬
			  if (header === 'OPS' || header === 'AVG') {
			    return parseFloat(value).toFixed(3);
			  }
		
			  // BetterWAR, PitcherWAR, ERA, WHIP, íƒ€ê²©, ì£¼ë£¨, ìˆ˜ë¹„, ì„ ë°œ, ë¶ˆíœ â†’ ì†Œìˆ˜ì  2ìë¦¬
			  if (['BetterWAR', 'PitcherWAR', 'ERA', 'WHIP', 'íƒ€ê²©', 'ì£¼ë£¨', 'ìˆ˜ë¹„', 'ì„ ë°œ', 'ë¶ˆíœ'].includes(header)) {
			    return parseFloat(value).toFixed(2);
			  }
		
			  // HR, SB, SO, BB â†’ ì •ìˆ˜
			  if (['HR', 'SB', 'SO', 'BB', 'H', 'SV', 'W'].includes(header)) {
			    return parseInt(value, 10);
			  }
		
			  // ê·¸ ì™¸ â†’ ì†Œìˆ˜ì  2ìë¦¬
			  return parseFloat(value).toFixed(2);
			}
			
		//í…Œì´ë¸” ê·¸ë¦¬ê¸° í•¨ìˆ˜
		function renderStatTable(list, headers, categoryNameMap, currentSort, sortDirection) {
		  var html = '<table id="ranking-table" class="table table-bordered table-striped text-center">';
		  html += '<thead><tr><th>ìˆœìœ„</th><th>íŒ€ëª…</th>';
		
		  $.each(headers, function(j, header) {
		    html += '<th><a href="javascript:void(0);" onclick="sortTable(\'' + header + '\')" data-header="' + header + '">' +
		             (categoryNameMap[header] || header) + ' ' +
		             (currentSort === header ? (sortDirection === 'ASC' ? 'â–²' : 'â–¼') : '') +
		             '</a></th>';
		  });
		
		  html += '</tr></thead><tbody>';
		
		  $.each(list, function(i, team) {
		    html += '<tr>' +
		      '<td>' + (i + 1) + '</td>' +
		      '<td>' + (team.teamName || '-') + '</td>';
		
		    $.each(headers, function(j, header) {
		      var field = convertHeaderToField(header);
		      var value = team[field] !== undefined ? formatValue(header, team[field]) : '-';
		      html += '<td>' + value + '</td>';
		    });
		
		    html += '</tr>';
		  });
		
		  html += '</tbody></table>';
		
		  $('#ranking-table-wrapper').html(html);
		}
		
		// íŒ€ ìˆœìœ„ ì¹´ë“œ
		function renderTeamRankingList(list) {
		  var html = '<table class="table text-center">';
		  html += '<thead><tr><th>ìˆœìœ„</th><th>íŒ€</th><th>ê²½ê¸°</th><th>ìŠ¹</th><th>íŒ¨</th><th>ë¬´</th><th>ìŠ¹ë¥ </th><th>ìŠ¹ì°¨</th></tr></thead><tbody>';
		  $.each(list, function(i, team) {
		    html += '<tr>' +
		      '<td>' + team.ranking + '</td>' +
		      '<td class="d-flex align-items-center gap-2"><img src="' + getLogoPath(team.logoName) + '" style="width:28px;height:28px;">' +
		      '<span>' + team.teamName + '</span></td>' +
		      '<td>' + team.games + '</td>' +
		      '<td>' + team.wins + '</td>' +
		      '<td>' + team.losses + '</td>' +
		      '<td>' + team.draws + '</td>' +
		      '<td>' + team.winRate + '</td>' +
		      '<td>' + team.gamesBehind + '</td>' +
		      '</tr>';
		  });
		  html += '</tbody></table>';
		  return html;
		}
		
		// íƒ€ì ìŠ¤íƒ¯ ì¹´ë“œ
		function renderTopBatterList(list, categoryNameMap) {
		  var html = '';
		  $.each(list, function(i, stat) {
		    var categoryName = categoryNameMap[stat.category] || stat.category; // ë§¤í•‘
		    html += '<li class="list-group-item d-flex justify-content-between">' +
		      '<span>' + categoryName + '</span>' +
			  '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
		      stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
		  });
		  return html;
		}
		
		// íˆ¬ìˆ˜ ìŠ¤íƒ¯ ì¹´ë“œ
		function renderTopPitcherList(list, categoryNameMap) {
		  var html = '';
		  $.each(list, function(i, stat) {
		    var categoryName = categoryNameMap[stat.category] || stat.category; // ğŸ”¥ í•œê¸€ ë³€í™˜
		    html += '<li class="list-group-item d-flex justify-content-between">' +
		      '<span>' + categoryName + '</span>' +
			  '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
		      stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
		  });
		  return html;
		}
		
		// WAA ìŠ¤íƒ¯ ì¹´ë“œ
		function renderTopWaaList(list) {
		  var html = '';
		  $.each(list, function(i, stat) {
			  html += '<li class="list-group-item d-flex justify-content-between">' +
			    '<span>' + stat.category + '</span>' +
			    '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
			    stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
			});
		  return html;
		}
		
		// ë¡œê³  í™•ì¥ì
		function getLogoPath(logoName) {
			  var svgTeams = ['DOOSAN', 'HANHWA'];

			  if (svgTeams.includes(logoName)) {
			    return '/static/emblems/' + logoName + '.svg';
			  } else {
			    return '/static/emblems/' + logoName + '.png';
			  }
			}
		</script>
	</th:block>
</html>