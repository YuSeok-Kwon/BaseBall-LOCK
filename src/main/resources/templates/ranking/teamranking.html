<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}">

<th:block layout:fragment="contents">
	<div class="container-fluid py-5 px-3">
	  
	  <!-- 시즌 선택 -->
	  <div class="d-flex align-items-center mb-4 mx-4">
	     <a href="/ranking/teamranking-view" class="btn btn-outline-secondary me-2" style="background-color: #FACC15;">팀 랭킹</a>
	  	<a href="/ranking/playerranking-view" class="btn btn-outline-primary" style="background-color: #FACC15;">개인 랭킹</a>
	    <form class="d-flex align-items-center px-4">
	      <select id="season-select" class="form-select" name="season" style="width:120px;" onchange="changeSeason(this.value)">
	        <option value="2025">2025</option>
	        <option value="2024">2024</option>
	        <option value="2023">2023</option>
	        <option value="2022">2022</option>
	        <option value="2021">2021</option>
	        <option value="2020">2020</option>
	      </select>
		  <input type="hidden" id="current-sort" name="sort" value="TotalWAR">
		  <input type="hidden" id="current-direction" name="direction" value="DESC">
	    </form>
	  </div>
	
	  <!-- 팀 순위, TOP 스탯 영역 -->
	  <div class="row gy-4 mx-5">
	    <div class="col-lg-4">
	      <div class="card border-point shadow-sm p-3">
	        <h5 class="text-center fw-bold mb-3">KBO 리그 팀 순위</h5>
	        <div id="team-ranking-list"></div>
	      </div>
	    </div>
	    <div class="col-lg-8">
	      <div class="row gy-4">
	        <div class="col-md-6">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">팀 타자 스탯 Top</h5>
	            <ul id="top-batter-list" class="list-group border"></ul>
	          </div>
	        </div>
	        <div class="col-md-6">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">팀 투수 스탯 Top</h5>
	            <ul id="top-pitcher-list" class="list-group border"></ul>
	          </div>
	        </div>
	        <div class="col-12">
	          <div class="card border-point p-3">
	            <h5 class="text-center fw-bold mb-3">팀 WAA 스탯 Top</h5>
	            <ul id="top-waa-list" class="list-group border"></ul>
	          </div>
	        </div>
	      </div>
	    </div>
	  </div>
	
	  <!-- 스탯 테이블 -->
	  <div id="ranking-table-wrapper" class="ranking-table mt-5 mx-5"></div>
	
	</div>
  </th:block>

  <th:block layout:fragment="script">
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		var season = document.getElementById('season-select').value;
		changeSeason(season);
		});
	
	// 시즌 변경
	function changeSeason(season) {
		
	  var currentSort = document.querySelector('input[name="sort"]').value;
	  var currentDirection = document.querySelector('input[name="direction"]').value;
	
	  $.ajax({
	    url: '/ranking/teamranking-view-json',
	    method: 'GET',
	    data: {
	      season: season,
	      sort: currentSort,
	      direction: currentDirection
	    },
	    success: function(data) {
	    	console.log("받은 데이터:", data);
	      // 카드뷰 부분
	      document.getElementById('team-ranking-list').innerHTML = renderTeamRankingList(data.rankingList);
	      document.getElementById('top-batter-list').innerHTML = renderTopBatterList(data.topBatterStats, data.categoryNameMap);
	      document.getElementById('top-pitcher-list').innerHTML = renderTopPitcherList(data.topPitcherStats, data.categoryNameMap);
	      document.getElementById('top-waa-list').innerHTML = renderTopWaaList(data.topWaaStats);
	
	      // 테이블 부분
	      renderStatTable(data.statRankingList, data.headers, data.categoryNameMap, data.currentSort, data.sortDirection);
	
	      // hidden input 업데이트
	      document.querySelector('input[name="sort"]').value = data.currentSort;
	      document.querySelector('input[name="direction"]').value = data.sortDirection;
	    },
	    error: function(xhr, status, error) {
	      console.error('시즌 변경 실패:', error);
	    }
	  });
	}
	
	// 테이블 정렬
	function sortTable(sortKey) {
	  var season = document.querySelector('select[name="season"]').value;
	  var currentSortInput = document.querySelector('input[name="sort"]');
	  var directionInput = document.querySelector('input[name="direction"]');
	
	  var currentSort = currentSortInput ? currentSortInput.value : 'TotalWAR';
	  var currentDirection = directionInput ? directionInput.value : 'DESC';
	
	  var newDirection = 'ASC';
	  if (currentSort.toUpperCase() === sortKey.toUpperCase() && currentDirection === 'ASC') {
	    newDirection = 'DESC';
	  }
	
	  $.ajax({
	    url: '/ranking/teamranking-view-json',
	    method: 'GET',
	    data: {
	      season: season,
	      sort: sortKey,
	      direction: newDirection
	    },
	    success: function(data) {
	      // 카드뷰 부분
	      document.getElementById('team-ranking-list').innerHTML = renderTeamRankingList(data.rankingList);
	      document.getElementById('top-batter-list').innerHTML = renderTopBatterList(data.topBatterStats, data.categoryNameMap);
	      document.getElementById('top-pitcher-list').innerHTML = renderTopPitcherList(data.topPitcherStats, data.categoryNameMap);
	      document.getElementById('top-waa-list').innerHTML = renderTopWaaList(data.topWaaStats);
	
	      // 테이블 부분
	      renderStatTable(data.statRankingList, data.headers, data.categoryNameMap, data.currentSort, data.sortDirection);
	
	      // hidden input 업데이트
	      if (currentSortInput) currentSortInput.value = sortKey;
	      if (directionInput) directionInput.value = newDirection;
	    },
	    error: function(xhr, status, error) {
	      console.error('정렬 실패:', error);
	    }
	  });
	}
	
	//테이블 출력
	function renderStatTable(list, headers, categoryNameMap, currentSort, sortDirection) {
	    var html = '<table id="ranking-table" class="table table-bordered table-striped text-center">';
	    html += '<thead><tr><th>순위</th><th>팀명</th>';
	
	    $.each(headers, function(j, header) {
	        html += '<th><a href="javascript:void(0);" onclick="sortTable(\'' + header + '\')" data-header="' + header + '">' +
	            (categoryNameMap[header] || header) + ' ' +
	            (currentSort === header ? (sortDirection === 'ASC' ? '▲' : '▼') : '') +
	            '</a></th>';
	    });
	
	    html += '</tr></thead><tbody>';
	
	    $.each(list, function(i, team) {
	        html += '<tr>';
	        html += '<td>' + (i + 1) + '</td>';
	        html += '<td>' + (team.teamName || '-') + '</td>';
	
	        $.each(headers, function(j, header) {
	            var field = convertHeaderToField(header);
	            var value = team[field];
	
	            var formatClass = getFormatClassForCategory(header);
	
	            if (value === undefined || value === null) {
	                value = '-';
	            } else {
	                if (formatClass === 'format-decimal-3') {
	                    value = formatDecimal(value, 3);
	                } else if (formatClass === 'format-decimal-2') {
	                    value = formatDecimal(value, 2);
	                } else if (formatClass === 'format-decimal-1') {
	                    value = formatDecimal(value, 1);
	                } else if (formatClass === 'format-integer') {
	                    value = formatInteger(value);
	                }
	            }
	
	            html += '<td class="' + formatClass + '">' + value + '</td>';
	        });
	
	        html += '</tr>';
	    });
	
	    html += '</tbody></table>';
	
	    $('#ranking-table-wrapper').html(html);
	
	    formatPlayerStats();
	}
	
	// 팀 순위 카드
	function renderTeamRankingList(list) {
	  var html = '<table class="table text-center">';
	  html += '<thead><tr><th>순위</th><th>팀</th><th>경기</th><th>승</th><th>패</th><th>무</th><th>승률</th><th>승차</th></tr></thead><tbody>';
	  $.each(list, function(i, team) {
	    html += '<tr>' +
	      '<td>' + team.ranking + '</td>' +
	      '<td class="d-flex align-items-center gap-2"><img src="' + getLogoPath(team.logoName) + '" style="width:28px;height:28px;">' +
	      '<span>' + team.teamName + '</span></td>' +
	      '<td>' + team.games + '</td>' +
	      '<td>' + team.wins + '</td>' +
	      '<td>' + team.losses + '</td>' +
	      '<td>' + team.draws + '</td>' +
	      '<td>' + team.winRate + '</td>' +
	      '<td>' + team.gamesBehind + '</td>' +
	      '</tr>';
	  });
	  html += '</tbody></table>';
	  return html;
	}
	
	// 타자 스탯 카드
	function renderTopBatterList(list, categoryNameMap) {
	  var html = '';
	  $.each(list, function(i, stat) {
	    var categoryName = categoryNameMap[stat.category] || stat.category;
	    html += '<li class="list-group-item d-flex justify-content-between">' +
	      '<span>' + categoryName + '</span>' +
		  '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
	      stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
	  });
	  return html;
	}
	
	// 투수 스탯 카드
	function renderTopPitcherList(list, categoryNameMap) {
	  var html = '';
	  $.each(list, function(i, stat) {
	    var categoryName = categoryNameMap[stat.category] || stat.category;
	    html += '<li class="list-group-item d-flex justify-content-between">' +
	      '<span>' + categoryName + '</span>' +
		  '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
	      stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
	  });
	  return html;
	}
	
	// WAA 스탯 카드
	function renderTopWaaList(list) {
	  var html = '';
	  $.each(list, function(i, stat) {
		  html += '<li class="list-group-item d-flex justify-content-between">' +
		    '<span>' + stat.category + '</span>' +
		    '<span><img src="' + getLogoPath(stat.teamLogo) + '" style="width:28px;height:28px;">' +
		    stat.teamName + ' <strong>' + stat.formattedValue + '</strong></span></li>';
		});
	  return html;
	}
	
	// 숫자 포맷 함수 통일
	function formatDecimal(value, decimals) {
		if (value == null || isNaN(value)) return '-';
		return parseFloat(value).toFixed(decimals);
	}
	
	function formatInteger(value) {
		if (value == null || isNaN(value)) return '-';
		return Math.round(value);
	}
	
	function getFormatClassForCategory(category) {
		if (!category) return 'format-decimal-2';
		const upper = category.toUpperCase();
		if (['ERA', 'WHIP', 'WAR', 'BetterWAR', 'PitcherWAR', '타격', '주루', '수비', '선발', '불펜'].includes(upper)) return 'format-decimal-2';
		if (['OPS', 'AVG'].includes(upper)) return 'format-decimal-3';
		if (upper === 'IP') return 'format-decimal-1';
		if (['W', 'L', 'SV', 'HLD', 'SO', 'BB', 'H', 'HR', 'G', 'SB', 'RBI', '2B', '3B'].includes(upper)) return 'format-integer';
		return 'format-decimal-2';
	}
	
	// 숫자 포맷 일괄 적용
	function formatPlayerStats() {
		document.querySelectorAll('.format-decimal-2').forEach(function(td) {
			let value = parseFloat(td.innerText);
			if (!isNaN(value)) td.innerText = value.toFixed(2);
		});
		document.querySelectorAll('.format-decimal-3').forEach(function(td) {
			let value = parseFloat(td.innerText);
			if (!isNaN(value)) td.innerText = value.toFixed(3);
		});
		document.querySelectorAll('.format-decimal-1').forEach(function(td) {
			let value = parseFloat(td.innerText);
			if (!isNaN(value)) td.innerText = value.toFixed(1);
		});
		document.querySelectorAll('.format-integer').forEach(function(td) {
			let value = parseFloat(td.innerText);
			if (!isNaN(value)) td.innerText = Math.round(value);
		});
	}
	
	// 기타 유틸
	function getLogoPath(logoName) {
		return logoName != null ? '/static/emblems/' + logoName + '.svg' : '/static/emblems/' + logoName + '.png';
	}
	
	function convertHeaderToField(header) {
		var map = {
			'TotalWAR': 'totalWar',
			'BetterWAR': 'betterWar',
			'OPS': 'ops',
			'AVG': 'avg',
			'HR': 'hr',
			'SB': 'sb',
			'PitcherWAR': 'pitcherWar',
			'SO': 'so',
			'ERA': 'era',
			'WHIP': 'whip',
			'BB': 'bb',
			'타격': 'battingWaa',
			'주루': 'baserunningWaa',
			'수비': 'defenseWaa',
			'선발': 'startingWaa',
			'불펜': 'bullpenWaa'
		};
		return map[header] || header;
	}
	</script>
	</th:block>
</html>