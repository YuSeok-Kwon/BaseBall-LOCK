<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/reviewDefault}">
<head>
  <style>
    input[type="checkbox"][disabled] + label {
      color: #000 !important;
      opacity: 1 !important;
    }
  </style>
</head>
<th:block layout:fragment="contents">

	<!-- ë¼ì¸ì—… ìŠ¬ë¡¯ ì˜ì—­ -->
	<div class="bg-light p-4 rounded shadow-sm mb-4">
	  <h5 class="text-center mb-3 fw-bold">ë¼ì¸ì—… êµ¬ì„±</h5>
	  <div id="lineupArea" class="d-flex flex-wrap justify-content-center gap-3">
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="1">1ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="2">2ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="3">3ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="4">4ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="5">5ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="6">6ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="7">7ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="8">8ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="9">9ë²ˆ íƒ€ì</div>
		  <div class="lineup-slot border rounded text-center py-3 px-2 fw-semibold" style="width: 150px;" data-position="P">íˆ¬ìˆ˜</div>
		</div>
		
		<div class="text-center my-4">
  <h6 class="fw-bold mb-3">í¬ì§€ì…˜ êµ¬ì„± ì²´í¬</h6>
  <div id="positionCheckArea" class="position-layout d-flex flex-column align-items-center gap-2">
    
    <div class="d-flex gap-4">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-LF" disabled>
        <label class="form-check-label" for="check-LF">ì¢Œìµìˆ˜</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-CF" disabled>
        <label class="form-check-label" for="check-CF">ì¤‘ê²¬ìˆ˜</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-RF" disabled>
        <label class="form-check-label" for="check-RF">ìš°ìµìˆ˜</label>
      </div>
    </div>

    <div class="d-flex gap-4 mt-3">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-SS" disabled>
        <label class="form-check-label" for="check-SS">ìœ ê²©ìˆ˜</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-2B" disabled>
        <label class="form-check-label" for="check-2B">2ë£¨ìˆ˜</label>
      </div>
    </div>  
    
    <div class="d-flex gap-4 mt-2">
      <div class="form-check form-check-inline pe-3">
        <input class="form-check-input" type="checkbox" id="check-3B" disabled>
        <label class="form-check-label" for="check-3B">3ë£¨ìˆ˜</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-P" disabled>
        <label class="form-check-label" for="check-P">íˆ¬ìˆ˜</label>
      </div>
      <div class="form-check form-check-inline ps-5">
        <input class="form-check-input" type="checkbox" id="check-1B" disabled>
        <label class="form-check-label" for="check-1B">1ë£¨ìˆ˜</label>
      </div>
    </div>

    <div class="d-flex gap-4 mt-2">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="check-C" disabled>
        <label class="form-check-label" for="check-C">í¬ìˆ˜</label>
      </div>
    </div>

    <div class="form-check form-check-inline">
      <input class="form-check-input" type="checkbox" id="check-DH" disabled>
      <label class="form-check-label" for="check-DH">ì§€ëª…íƒ€ì</label>
    </div>
  </div>
</div>
	</div>
	
	<!-- ì¹´ë“œ ë³´ê´€í•¨ -->
	<div class="bg-light p-4 rounded shadow-sm">
	  <!-- ë“±ê¸‰/í¬ì§€ì…˜ í•„í„° -->
	  <div class="d-flex gap-3 align-items-center mb-3">
	    <h5 class="fw-bold mb-3">ë³´ìœ í•œ ì„ ìˆ˜ ì¹´ë“œ</h5>
	    <select id="gradeFilter" class="form-select" style="width: 150px;">
	      <option value="">ì „ì²´ ë“±ê¸‰</option>
	      <option value="S">S</option>
	      <option value="A">A</option>
	      <option value="B">B</option>
	      <option value="C">C</option>
	    </select>
	    <select id="positionFilter" class="form-select" style="width: 150px;">
	      <option value="">ì „ì²´ í¬ì§€ì…˜</option>
	      <option value="P">íˆ¬ìˆ˜</option>
	      <option value="1B">1ë£¨ìˆ˜</option>
	      <option value="2B">2ë£¨ìˆ˜</option>
	      <option value="3B">3ë£¨ìˆ˜</option>
	      <option value="SS">ìœ ê²©ìˆ˜</option>
	      <option value="LF">ì¢Œìµìˆ˜</option>
	      <option value="CF">ì¤‘ê²¬ìˆ˜</option>
	      <option value="RF">ìš°ìµìˆ˜</option>
	      <option value="C">í¬ìˆ˜</option>
	      <option value="DH">ì§€ëª…íƒ€ì</option>
	    </select>
	  </div>
	  <div id="cardStorageArea" class="d-flex flex-wrap gap-2"></div>
	</div>
	
	<!-- ì €ì¥ ë²„íŠ¼ -->
	<div class="text-center mt-4">
	  <button id="saveLineupBtn" class="btn btn-success btn-lg px-5 mb-5">
	    ğŸ’¾ ë¼ì¸ì—… ì €ì¥
	  </button>
	  <a href="/game/ready-view" class="btn btn-primary btn-lg px-5 mb-5">
	    ğŸ® ê²Œì„í•˜ëŸ¬ ê°€ê¸°
	  </a>
    </div>
</th:block>

<th:block layout:fragment="script">
<script>
	//ì¹´ë“œ í•„í„° ì ìš©
	function applyCardFilter() {
	  const grade = document.getElementById('gradeFilter').value;
	  const pos = document.getElementById('positionFilter').value;
	  const storage = document.getElementById('cardStorageArea');
	  storage.innerHTML = '';
	
	  const positionOrder = {
	    'P': 0, 'C': 1, '1B': 2, '2B': 3, '3B': 4, 'SS': 5,
	    'LF': 6, 'CF': 7, 'RF': 8, 'DH': 9
	  };
	
	  const sorted = [];
	  for (let i = 0; i < allMyCards.length; i++) {
	    sorted.push(allMyCards[i]);
	  }
	  sorted.sort(function (a, b) {
	    return (positionOrder[a.position] || 99) - (positionOrder[b.position] || 99);
	  });
	
	  for (let i = 0; i < sorted.length; i++) {
	    const c = sorted[i];
	    if (grade && c.grade !== grade) continue;
	    if (pos && c.position !== pos) continue;
	    storage.appendChild(createStorageCard(c));
	  }
	}
	
	// ë¼ì¸ì—… ìœ íš¨ì„± ê²€ì‚¬
	function isValidLineup() {
	  if (selectedLineup.length !== 10) {
	    alert('ëª¨ë“  ìŠ¬ë¡¯ì„ ì±„ì›Œì£¼ì„¸ìš”');
	    return false;
	  }
	
	  let pitcherCount = 0;
	  let positionCount = {};
	  let playerSet = {};
	
	  for (let i = 0; i < selectedLineup.length; i++) {
	    const entry = selectedLineup[i];
	    if (playerSet[entry.playerId]) {
	      alert('ë™ì¼ ì„ ìˆ˜ë¥¼ ì¤‘ë³µ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
	      return false;
	    }
	    playerSet[entry.playerId] = true;
	
	    if (positionCount[entry.position]) {
	      positionCount[entry.position]++;
	    } else {
	      positionCount[entry.position] = 1;
	    }
	
	    if (entry.position === 'P') {
	      pitcherCount++;
	    }
	  }
	
	  if (pitcherCount !== 1) {
	    alert('íˆ¬ìˆ˜ëŠ” ë°˜ë“œì‹œ 1ëª…ë§Œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
	    return false;
	  }
	
	  const requiredPositions = ['C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF'];
	  let missing = [];
	  let duplicated = [];
	
	  for (let i = 0; i < requiredPositions.length; i++) {
	    const pos = requiredPositions[i];
	    const count = positionCount[pos] || 0;
	    if (count === 0) missing.push(pos);
	    else if (count > 1) duplicated.push(pos);
	  }
	
	  if (duplicated.length > 1) {
	    alert('í¬ì§€ì…˜ ì¤‘ë³µì€ í•˜ë‚˜ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.\nì¤‘ë³µëœ í¬ì§€ì…˜: ' + duplicated.join(', '));
	    return false;
	  }
	
	  if (missing.length > 1) {
	    alert('ë‹¤ìŒ í¬ì§€ì…˜ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' + missing.join(', ') + '\nìµœëŒ€ í•œ ê°œë§Œ ì§€ëª…íƒ€ìë¡œ ëŒ€ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
	    return false;
	  }
	
	  return true;
	}
	
	// í¬ì§€ì…˜ ì²´í¬ë°•ìŠ¤ ê°±ì‹ 
	function updatePositionSummary() {
	  const checkIds = ['C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF', 'DH', 'P'];
	  for (let i = 0; i < checkIds.length; i++) {
	    const checkbox = document.getElementById('check-' + checkIds[i]);
	    if (checkbox) {
	      checkbox.checked = false;
	    }
	  }
	
	  const positionCount = {};
	  let dhAssigned = false;
	
	  for (let i = 0; i < selectedLineup.length; i++) {
	    const pos = selectedLineup[i].position;
	    positionCount[pos] = (positionCount[pos] || 0) + 1;
	  }
	
	  for (const pos in positionCount) {
	    const checkbox = document.getElementById('check-' + pos);
	    if (checkbox) checkbox.checked = true;
	
	    if (positionCount[pos] > 1 && !dhAssigned && pos !== 'DH') {
	      const dhCheckbox = document.getElementById('check-DH');
	      if (dhCheckbox) dhCheckbox.checked = true;
	      dhAssigned = true;
	    }
	  }
	}
	
	// ì¹´ë“œ UI ìƒì„±
	function createStorageCard(card) {
	  const cardDiv = document.createElement('div');
	  cardDiv.className = 'storage-card card text-center p-2';
	  cardDiv.style.width = '90px';
	  cardDiv.style.fontSize = '0.75rem';
	  cardDiv.style.border = '2px solid ' + card.teamColor;
	
	  cardDiv.setAttribute('draggable', 'true');
	  cardDiv.setAttribute('data-player-id', card.playerId);
	  cardDiv.setAttribute('data-player-name', card.playerName);
	  cardDiv.setAttribute('data-position', card.position);
	  cardDiv.setAttribute('data-season', card.season);
	
	  cardDiv.innerHTML =
	    '<div class="fw-bold">' + card.playerName + '</div>' +
	    '<div>' + card.grade + 'ë“±ê¸‰</div>' +
	    '<div class="text-secondary">' + card.position + '</div>';
	
	  cardDiv.addEventListener('dragstart', function (event) {
	    event.dataTransfer.setData('playerId', card.playerId);
	    event.dataTransfer.setData('playerName', card.playerName);
	    event.dataTransfer.setData('position', card.position);
	    event.dataTransfer.setData('season', card.season);
	  });
	
	  return cardDiv;
	}
	
	// ì €ì¥ëœ ì¹´ë“œ ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
	function loadMyCards() {
	  $.ajax({
	    url: '/game/lineup/my-cards',
	    method: 'GET',
	    success: function(cards) {
	      allMyCards = cards;

	      var positionOrder = {
	        'P': 10, 'C': 1, '1B': 2, '2B': 3, '3B': 4, 'SS': 5,
	        'LF': 6, 'CF': 7, 'RF': 8, 'DH': 9
	      };

	      cards.sort(function(a, b) {
	        var aOrder = positionOrder[a.position] || 99;
	        var bOrder = positionOrder[b.position] || 99;
	        return aOrder - bOrder;
	      });

	      var container = $('#cardStorageArea');
	      container.empty();

	      for (var i = 0; i < cards.length; i++) {
	        container.append(createStorageCard(cards[i]));
	      }
	    },
	    error: function() {
	      alert('ì¹´ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
	    }
	  });
	}

	// ì €ì¥ëœ ë¼ì¸ì—… ì •ë³´ë¥¼ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
	function loadExistingLineup() {
	  $.ajax({
	    url: '/game/lineup/my-lineup',
	    method: 'GET',
	    success: function(lineup) {
	      for (var i = 0; i < lineup.length; i++) {
	        var p = lineup[i];
	        var slot = $('.lineup-slot[data-position="' + p.orderNum + '"]');

	        if (slot.length > 0) {
	          slot.text(p.playerName + ' (' + p.position + ')');
	          slot.attr('data-player-id', p.playerId);
	          slot.addClass('bg-warning');

	          selectedLineup.push({
	            playerId: p.playerId,
	            position: p.position,
	            orderNum: p.orderNum,
	            season: p.season
	          });
	        }
	      }
	      updatePositionSummary();
	    },
	    error: function() {
	      alert('ë¼ì¸ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
	    }
	  });
	}
	
	// ìŠ¬ë¡¯ ë“œë¡­ ë° í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
	function setupSlotEvents() {
	  const slots = document.querySelectorAll('.lineup-slot');
	  for (let i = 0; i < slots.length; i++) {
	    const slot = slots[i];
	    slot.addEventListener('dragover', function (e) { e.preventDefault(); });
	
	    slot.addEventListener('drop', function (e) {
    	  e.preventDefault();

    	  const playerId = parseInt(e.dataTransfer.getData('playerId'));
    	  const playerName = e.dataTransfer.getData('playerName');
    	  const position = e.dataTransfer.getData('position');
    	  const season = parseInt(e.dataTransfer.getData('season'));
    	  const orderNum = this.getAttribute('data-position');

    	  if (this.getAttribute('data-player-id')) {
    	    alert('ì´ë¯¸ ë°°ì¹˜ëœ ìŠ¬ë¡¯ì…ë‹ˆë‹¤.');
    	    return;
    	  }

    	  // ë™ì¼ ì„ ìˆ˜ ì¤‘ë³µ ë°©ì§€
    	  for (let i = 0; i < selectedLineup.length; i++) {
    	    if (selectedLineup[i].playerId === playerId) {
    	      alert('ë™ì¼ ì„ ìˆ˜ë¥¼ ì¤‘ë³µ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    	      return;
    	    }
    	  }

    	  const isPitcherSlot = orderNum === 'P';
    	  const isPitcher = position === 'P';
    	  if (isPitcherSlot !== isPitcher) {
    	    alert('í¬ì§€ì…˜ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    	    return;
    	  }

    	  const mainPositions = ['C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF'];
    	  const positionCount = {};
    	  let dhExists = false;

    	  for (let i = 0; i < selectedLineup.length; i++) {
    	    const pos = selectedLineup[i].position;
    	    if (positionCount[pos]) {
    	      positionCount[pos]++;
    	    } else {
    	      positionCount[pos] = 1;
    	    }
    	    if (pos === 'DH') {
    	      dhExists = true;
    	    }
    	  }

    	  // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ì„ ìˆ˜ í¬ì§€ì…˜ë„ ë°˜ì˜
    	  if (positionCount[position]) {
    	    positionCount[position]++;
    	  } else {
    	    positionCount[position] = 1;
    	  }

    	  // ì¤‘ë³µëœ í¬ì§€ì…˜ì´ 2ê°œ ì´ìƒì¸ì§€ ìˆ˜ë™ ê²€ì‚¬
    	  let duplicateCount = 0;
    	  const duplicateList = [];

    	  for (let i = 0; i < mainPositions.length; i++) {
    	    const pos = mainPositions[i];
    	    const count = positionCount[pos] || 0;
    	    if (count > 1) {
    	      duplicateCount++;
    	      duplicateList.push(pos);
    	    }
    	    if (count > 2) {
    	      alert(pos + ' í¬ì§€ì…˜ì€ ìµœëŒ€ 2ëª…ê¹Œì§€ë§Œ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    	      return;
    	    }
    	  }

    	  if (duplicateCount > 1) {
    	    alert('í¬ì§€ì…˜ ì¤‘ë³µì€ í•˜ë‚˜ê¹Œì§€ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.\nì¤‘ë³µëœ í¬ì§€ì…˜: ' + duplicateList.join(', '));
    	    return;
    	  }

    	  if (dhExists && duplicateCount > 0) {
    	    alert('ì§€ëª…íƒ€ìê°€ ë°°ì¹˜ë˜ì–´ ìˆì–´ í¬ì§€ì…˜ ì¤‘ë³µì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    	    return;
    	  }
    	  
    	  if (position === 'DH' && duplicateCount > 0) {
    		  alert('í¬ì§€ì…˜ ì¤‘ë³µì´ ì´ë¯¸ ì¡´ì¬í•´ ì§€ëª…íƒ€ìë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    		  return;
    		}
    	  
    	  for (let i = 0; i < selectedLineup.length; i++) {
    	    if (selectedLineup[i].orderNum === orderNum) {
    	      selectedLineup.splice(i, 1);
    	      break;
    	    }
    	  }

    	  selectedLineup.push({
    	    playerId: playerId,
    	    position: position,
    	    orderNum: orderNum,
    	    season: season
    	  });

    	  this.innerText = playerName + ' (' + position + ')';
    	  this.setAttribute('data-player-id', playerId);
    	  this.classList.remove('bg-white');
    	  this.classList.add('bg-warning');

    	  updatePositionSummary();
    	});
	
	    slot.addEventListener('click', function () {
	      const playerId = this.getAttribute('data-player-id');
	      const orderNum = this.getAttribute('data-position');
	      if (!playerId) return;
	
	      for (let n = 0; n < selectedLineup.length; n++) {
	        if (selectedLineup[n].playerId === parseInt(playerId)) {
	          selectedLineup.splice(n, 1);
	          break;
	        }
	      }
	      this.removeAttribute('data-player-id');
	      this.classList.remove('bg-warning');
	      this.innerText = (orderNum === 'P') ? 'íˆ¬ìˆ˜' : orderNum + 'ë²ˆ íƒ€ì';
	      updatePositionSummary();
	    });
	  }
	}
	
	// ë¼ì¸ì—… ì €ì¥ ìš”ì²­ì„ ì„œë²„ì— ë³´ë‚´ëŠ” í•¨ìˆ˜
	function setupSaveButton() {
	  $('#saveLineupBtn').on('click', function() {
	    if (!isValidLineup()) return;

	    $.ajax({
	      url: '/game/lineup/clear',
	      method: 'DELETE',
	      success: function() {
	        $.ajax({
	          url: '/game/lineup/save-all',
	          method: 'POST',
	          contentType: 'application/json',
	          data: JSON.stringify(selectedLineup),
	          success: function() {
	            alert('ë¼ì¸ì—… ì €ì¥ ì™„ë£Œ');
	          },
	          error: function() {
	            alert('ë¼ì¸ì—… ì €ì¥ ì‹¤íŒ¨');
	          }
	        });
	      },
	      error: function() {
	        alert('ë¼ì¸ì—… ì´ˆê¸°í™” ì‹¤íŒ¨');
	      }
	    });
	  });
	}
	
	// ì´ˆê¸° ì‹¤í–‰
	let selectedLineup = [];
	let allMyCards = [];
	
	document.addEventListener('DOMContentLoaded', async function () {
	  await loadMyCards();
	  await loadExistingLineup();
	  setupSlotEvents();
	  setupSaveButton();
	  document.getElementById('gradeFilter').addEventListener('change', applyCardFilter);
	  document.getElementById('positionFilter').addEventListener('change', applyCardFilter);
	});
</script>
</th:block>

</html>
