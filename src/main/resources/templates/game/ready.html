<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/noheader}">
<head>
  <style>
    html, body {
	  margin: 0;
	  padding: 0;
	  width: 100%;
	  height: 100%;
	  overflow-x: hidden; /* ì¢Œìš° ìŠ¤í¬ë¡¤ ë°©ì§€ */
	}
	body {
	  background-image: url('/static/game/ready.png');
	  background-size: cover;
	  background-position: center;
	  background-repeat: no-repeat;
	  min-height: 100vh;
	  width: 100%;
	}
	
	#wrap {
	  height: 100%;
	  width: 100%;
	  display: flex;
      flex-direction: column;
	}
	
	.main-wrapper {
	  flex: 1;
      display: flex;
	  position: relative;
	  flex-direction: column;
      justify-content: space-between;
	  width: 100%;
	  min-height: 100%;
	  overflow: hidden;
	  padding-bottom: 80px;
	}
	
	.overlay {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  background-color: rgba(0,0,0,0.6);
	  z-index: 0;
	}
	
	.content.container,
	.content.container-fluid {
	  padding-left: 0 !important;
	  padding-right: 0 !important;
	  margin: 0 auto;     /* ì¤‘ì•™ ì •ë ¬ì„ ë³´ì¥ */
	  max-width: 100%;    /* ğŸ”¥ Bootstrap ê¸°ë³¸ ì œí•œ í•´ì œ */
	}

	.content {
	  flex-grow: 1;
	  position: relative;
	  z-index: 1;
	}
	
	#user-lineup > div,
	#bot-lineup > div {
	  min-width: unset;
	  max-width: 10%;
	  box-sizing: border-box;
	}
	
	footer {
  flex-shrink: 0;
}
	/* í¬ê¸°ë¥¼ ì¤„ì¸ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
	.pokemon-card {
	  width: 100%;
	  max-width: 130px;
	  height: 220px;    
	  perspective: 1000px;
	  margin: 0 !important;
	  font-size: 0.65rem; 
	  border-radius: 10px;
	  overflow: hidden;
	}
	
	.card-banner {
	  border-top-left-radius: 10px;
	  border-top-right-radius: 10px;
	  border-bottom-left-radius: 0;
	  border-bottom-right-radius: 0;
	  padding: 0.25rem 0.5rem;
	  position: absolute;
	  top: 0;
	  left: 0;
	  right: 0;
	  background-color: rgba(0, 0, 0, 0.5);
	  color: white;
	  font-size: 0.7rem;
	  z-index: 2;
	}
	.card-inner {
	  width: 100%;
	  height: 100%;
	  transition: transform 0.6s;
	  transform-style: preserve-3d;
	  position: relative;
	}
	
	.card-front, .card-back {
	  width: 100%;
	  height: 100%;
	  backface-visibility: hidden;
	  position: absolute;
	  border-radius: 10px;
	  padding: 0.5rem;
	}
	
	.card-front {
	  background-color: #ffffff10;
	  color: white;
	}
	.card-stats{
	  font-size: 0.8rem;
	  color: black;
	}
	.card-back {
	  background-color: #000000cc;
	  color: white;
	  transform: rotateY(180deg);
	}
	#user-lineup,
	#bot-lineup {
	  display: grid !important;
	  grid-template-columns: repeat(10, 1fr);
	  gap: 1px;
	  justify-items: center;
	}
	
	#user-lineup > div,
	#bot-lineup > div {
	  flex: 1 1 10%;
	  max-width: 10%; 
	  min-width: 100px; 
}
  </style>
</head>
<th:block layout:fragment="contents">
    <main class="main-wrapper" data-user-id="[[${session.userId}]]">
      <div class="overlay"></div>
		<div class="content container-fluid">
		
		  <!-- ìœ ì € ë¼ì¸ì—… -->
		  <div class="pt-3">
		    <h3 class="text-center text-white mb-2 d-flex justify-content-center align-items-center gap-3">
			  ë‚´ ë¼ì¸ì—…
                <a href="/game/lineup-view" class="btn btn-light btn-sm ms-3">ë¼ì¸ì—… êµ¬ì„±í•˜ê¸°</a>
            </h3>
		    <div class="text-white text-center mb-1" id="user-summary"></div>
            <div class="d-flex flex-wrap justify-content-center" id="user-lineup"></div>
		  </div>
		
		  <!-- ë´‡ ë¼ì¸ì—… -->
		  <div class="">
		    <div class="d-flex justify-content-center align-items-center text-center text-white mb-2">
		    <h3 class="text-center text-white mb-2">BOT ë¼ì¸ì—…</h3>
			  <label for="difficulty-select" class="mx-2">ë‚œì´ë„</label>
			  <select id="difficulty-select" class="form-select d-inline-block w-auto">
			    <option value="easy">ì‰¬ì›€</option>
			    <option value="normal" selected>ë³´í†µ</option>
			    <option value="hard">ì–´ë ¤ì›€</option>
			  </select>
			</div>
		    <div class="text-white text-center mb-1" id="bot-summary"></div>
            <div class="d-flex flex-wrap justify-content-center" id="bot-lineup"></div>
		  </div>
		
		  <!-- ì‹œì‘ ë²„íŠ¼ -->
		  <div class="text-center mt-2 mb-5">
		    <a href="/game/play-view" class="btn btn-light btn-sm ms-3">ê²Œì„ ì‹œì‘</a>
		  </div>
		  
		</div>
	</main>
</th:block>

<th:block layout:fragment="script">
<script th:inline="javascript">
    const userId = [[${session.userId}]];
</script>
<script>
	//í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰: ë‚œì´ë„ ì„ íƒ ë° ë¼ì¸ì—… ì´ˆê¸° ë¡œë“œ
	$(document).ready(function () {
	  var difficulty = $('#difficulty-select').val();
	
	  // ì„œë²„ì—ì„œ ë¼ì¸ì—…ì„ ë¶ˆëŸ¬ì˜¤ê³  ë´‡ íŒ€ê³¼ í•¨ê»˜ êµ¬ì„±
	  function loadLineups() {
	    $.ajax({
	      url: '/game/user/lineup',
	      method: 'GET',
	      data: { userId: userId },
	      success: function (userLineup) {
	        $.ajax({
	          url: '/game/ready?difficulty=' + encodeURIComponent(difficulty),
	          method: 'POST',
	          contentType: 'application/json',
	          data: JSON.stringify(userLineup),
	          success: function (data) {
	            renderCardLineup(data.user, $('#user-lineup')[0]);
	            renderCardLineup(data.bot, $('#bot-lineup')[0]);
	            renderSummaryStats(data.user, $('#user-summary')[0]);
	            renderSummaryStats(data.bot, $('#bot-summary')[0]);
	          },
	          error: function () {
	            console.error('ìƒëŒ€ ë¼ì¸ì—… ìƒì„± ì‹¤íŒ¨');
	          }
	        });
	      },
	      error: function () {
	        console.error('ìœ ì € ë¼ì¸ì—… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
	      }
	    });
	  }
	
	  // ë‚œì´ë„ ì„ íƒ ë³€ê²½ ì‹œ ë¼ì¸ì—… ì¬ë¡œë”©
	  $('#difficulty-select').on('change', function () {
	    difficulty = $(this).val();
	    loadLineups();
	  });
	
	  loadLineups();
	});
	
	
	// ë¼ì¸ì—… ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ í™”ë©´ì— ì¶œë ¥
	function renderCardLineup(cardViews, container) {
	  container.innerHTML = '';
	
	  cardViews.sort(function (a, b) {
	    return parseInt(a.lineup.orderNum) - parseInt(b.lineup.orderNum);
	  });
	
	  for (var i = 0; i < cardViews.length; i++) {
	    var view = cardViews[i];
	    var element = createCardElement(view.card, view.lineup.orderNum);
	    container.appendChild(element);
	  }
	}
	
	// ì¹´ë“œ ìš”ì†Œ í•˜ë‚˜ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜
	function createCardElement(card, orderNum) {
	  var wrapper = document.createElement('div');
	  wrapper.className = 'd-flex flex-column align-items-center mb-3';
	  wrapper.style.minWidth = '180px';
	
	  var flipWrapper = document.createElement('div');
	  flipWrapper.className = 'pokemon-card card card-flip';
	  flipWrapper.setAttribute('data-player-id', card.playerId);
	
	  var inner = document.createElement('div');
	  inner.className = 'card-inner';
	
	  // ì•ë©´ êµ¬ì„±
	  var front = document.createElement('div');
	  front.className = 'card-front grade-' + card.grade;
	
	  var banner = document.createElement('div');
	  banner.className = 'card-banner d-flex justify-content-between';
	  banner.innerHTML = '<span class="grade-label">' + card.grade + ' ë“±ê¸‰</span><span class="season">' + card.season + '</span>';
	  front.appendChild(banner);
	
	  if (card.grade === 'S' && card.imagePath) {
	    var imageWrapper = document.createElement('div');
	    imageWrapper.className = 'card-image-wrapper';
	    imageWrapper.innerHTML = '<img src="/' + card.imagePath + '" class="card-image hologram" alt="' + card.playerName + '">';
	    front.appendChild(imageWrapper);
	  }
	
	  var info = document.createElement('div');
	  info.className = 'card-info text-center text-black mt-5';
	  info.innerHTML = '<h5 class="player-name">' + card.playerName + '</h5>';
	  front.appendChild(info);
	
	  var overall = document.createElement('div');
	  overall.className = 'text-center fw-bold text-black fs-6';
	  overall.innerHTML = '<strong>Overall: ' + card.overall + '</strong>';
	  front.appendChild(overall);
	
	  var stats = document.createElement('div');
	  stats.className = 'card-stats text-center';
	  stats.innerHTML = getStatHTML(card);
	  front.appendChild(stats);
	
	  // ë’·ë©´ êµ¬ì„±
	  var back = document.createElement('div');
	  back.className = 'card-back grade-' + card.grade;
	  back.innerHTML = getBackStatHTML(card);
	
	  // ë§ˆìš°ìŠ¤ ë°©í–¥ì— ë”°ë¼ ì¹´ë“œ íšŒì „
	  flipWrapper.addEventListener('mousemove', function (e) {
	    var rect = flipWrapper.getBoundingClientRect();
	    var x = e.clientX - rect.left;
	    if (x < rect.width / 2) {
	      inner.style.transform = 'rotateY(0deg)';
	    } else {
	      inner.style.transform = 'rotateY(180deg)';
	    }
	  });
	
	  flipWrapper.addEventListener('mouseleave', function () {
	    inner.style.transform = 'rotateY(0deg)';
	  });
	
	  inner.appendChild(front);
	  inner.appendChild(back);
	  flipWrapper.appendChild(inner);
	  wrapper.appendChild(flipWrapper);
	
	  var orderLabel = document.createElement('div');
	  orderLabel.className = 'mt-2 text-white fw-bold';
	  orderLabel.innerText = orderNum === '10' ? 'íˆ¬ìˆ˜' : orderNum + 'ë²ˆ íƒ€ì';
	  wrapper.appendChild(orderLabel);
	
	  return wrapper;
	}
	
	// ì¹´ë“œ ì•ë©´ ìŠ¤íƒ¯ ì •ë³´ ì¶œë ¥
	function getStatHTML(card) {
	  var html = '<p>WAR: ' + (card.war ?? 0) + '</p>';
	  if (card.position === 'P') {
	    html += '<p>ERA: ' + (card.era ?? 0) + '</p>';
	    html += '<p>WHIP: ' + (card.whip ?? 0) + '</p>';
	    if (card.wins >= card.saves && card.wins >= card.holds && card.wins > 0) {
	      html += '<p>' + card.wins + 'ìŠ¹</p>';
	    } else if (card.saves >= card.holds && card.saves > 0) {
	      html += '<p>' + card.saves + 'ì„¸ì´ë¸Œ</p>';
	    } else if (card.holds > 0) {
	      html += '<p>' + card.holds + 'í™€ë“œ</p>';
	    }
	  } else {
	    html += '<p>AVG: ' + (card.avg ?? 0) + '</p>';
	    html += '<p>OPS: ' + (card.ops ?? 0) + '</p>';
	  }
	  return html;
	}
	
	// ì¹´ë“œ ë’·ë©´ ëŠ¥ë ¥ì¹˜ ì¶œë ¥
	function getBackStatHTML(card) {
	  if (card.position === 'P') {
	    return (
	      '<h6>ëŠ¥ë ¥ì¹˜ ìš”ì•½</h6>' +
	      '<p>ì»¨íŠ¸ë¡¤: ' + card.control + '</p>' +
	      '<p>êµ¬ìœ„: ' + card.stuff + '</p>' +
	      '<p>ì§€êµ¬ë ¥: ' + card.stamina + '</p>' +
	      '<p><strong>Overall: ' + card.overall + '</strong></p>'
	    );
	  } else {
	    return (
	      '<h6>ëŠ¥ë ¥ì¹˜ ìš”ì•½</h6>' +
	      '<p>íŒŒì›Œ: ' + card.power + '</p>' +
	      '<p>ì»¨íƒ: ' + card.contact + '</p>' +
	      '<p>ì„ êµ¬: ' + card.discipline + '</p>' +
	      '<p>ìŠ¤í”¼ë“œ: ' + card.speed + '</p>' +
	      '<p><strong>Overall: ' + card.overall + '</strong></p>'
	    );
	  }
	}
	
	// ìš”ì•½ ìŠ¤íƒ¯ í‰ê· ì„ ê³„ì‚°í•´ í™”ë©´ì— ì¶œë ¥
	function renderSummaryStats(cardViews, targetElement) {
	  var sum = {
	    overall: 0,
	    power: 0,
	    contact: 0,
	    discipline: 0,
	    speed: 0,
	    control: 0,
	    stuff: 0,
	    stamina: 0,
	    count: 0,
	    batterCount: 0,
	    pitcherCount: 0
	  };
	
	  for (var i = 0; i < cardViews.length; i++) {
	    var card = cardViews[i].card;
	    sum.overall += card.overall || 0;
	    sum.count++;
	
	    if (card.position === 'P') {
	      sum.control += card.control || 0;
	      sum.stuff += card.stuff || 0;
	      sum.stamina += card.stamina || 0;
	      sum.pitcherCount++;
	    } else {
	      sum.power += card.power || 0;
	      sum.contact += card.contact || 0;
	      sum.discipline += card.discipline || 0;
	      sum.speed += card.speed || 0;
	      sum.batterCount++;
	    }
	  }
	
	  var avg = {
	    overall: (sum.overall / sum.count).toFixed(1),
	    power: (sum.power / sum.batterCount).toFixed(1),
	    contact: (sum.contact / sum.batterCount).toFixed(1),
	    discipline: (sum.discipline / sum.batterCount).toFixed(1),
	    speed: (sum.speed / sum.batterCount).toFixed(1),
	    control: (sum.control / sum.pitcherCount).toFixed(1),
	    stuff: (sum.stuff / sum.pitcherCount).toFixed(1),
	    stamina: (sum.stamina / sum.pitcherCount).toFixed(1)
	  };
	
	  targetElement.innerHTML =
	    '<p class="mb-1">Overall: ' + avg.overall + '</p>' +
	    '<p class="mb-1">íƒ€ì â†’ íŒŒì›Œ ' + avg.power + ' / ì»¨íƒ ' + avg.contact +
	    ' / ì„ êµ¬ ' + avg.discipline + ' / ìŠ¤í”¼ë“œ ' + avg.speed + '</p>' +
	    '<p class="mb-3">íˆ¬ìˆ˜ â†’ ì»¨íŠ¸ë¡¤ ' + avg.control + ' / êµ¬ìœ„ ' + avg.stuff +
	    ' / ì§€êµ¬ë ¥ ' + avg.stamina + '</p>';
	}
</script>
</th:block>