<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/noheadefooter}">

<head>
  <style>
    body {
      background-image: url('/static/game/ground.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      height: 120vh;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      pointer-events: none;
      z-index: -1;
    }

    /* ë£¨ ë° ì£¼ì */
    .base-point {
      position: absolute;
      font-size: 1.4rem;
	  font-weight: bold;
	  color: white;
	  background: transparent;
	  opacity: 1;
	}

    .runner-icon {
      position: absolute;
      font-size: 3rem;
      transition: top 0.2s ease, left 0.2s ease;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
    
	.play-by-play-wrapper {
	  width: 1200px;
	  height: 120px;
	  margin: 2rem auto;
	  background-color: rgba(0, 0, 0, 0.6);
	  padding: 1rem;
	  border-radius: 1rem;
	  box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
	  border: 2px solid #ffffff44;
	  overflow: hidden; /* ìì‹ ìš”ì†Œê°€ ë„˜ì¹˜ì§€ ì•Šê²Œ ê°•ì œ ì°¨ë‹¨ */
	}
	
	#play-by-play {
	  height: 80px;
	  overflow-y: auto; 
	  font-size: 1.1rem;
	  color: white;
	  line-height: 1;
	  font-family: 'Noto Sans KR', sans-serif;
	  white-space: normal;
	  word-break: break-word;
	  padding-right: 4px;
	}
	#play-by-play::-webkit-scrollbar {
	  display: none;
	}
	/* ë¼ì¸ì—… ì¹´ë“œ */
	.card-mini {
	  font-size: 0.75rem;
	  padding: 4px 8px;
	  width : 90px;
	  border: 1px solid #ccc;
	  border-radius: 6px;
	  background-color: #f8f9fa;
	  z-index: 10;
	  box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
	}
  </style>
</head>

<th:block layout:fragment="contents">
  <div class="overlay" 
       th:attr="data-schedule-id=${scheduleId}, data-user-id=${userId}">
  </div>

  <div class="container-fluid d-flex flex-column" style="position: relative;">
    <div class="text-center mt-5">
		<div id="game-button-area" class="text-center mt-5">
		  <button id="start-game-btn" class="btn btn-warning fw-bold px-4 py-2">ğŸ ê²½ê¸° ì‹œì‘</button>
		</div>
	</div>
    <!-- ìŠ¤ì½”ì–´ë³´ë“œ -->
    <div id="score-board" class="text-white text-center pt-3">
      <table class="table table-bordered table-sm text-white mb-0" style="background-color: rgba(0,0,0,0.3);">
        <thead>
          <tr>
            <th>íŒ€</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>í•©ê³„</th>
          </tr>
        </thead>
        <tbody>
          <tr id="user-score-row">
            <td>ğŸ§‘</td>
            <td id="u0"></td><td id="u1"></td><td id="u2"></td><td id="u3"></td><td id="u4"></td>
            <td id="u5"></td><td id="u6"></td><td id="u7"></td><td id="u8"></td>
            <td id="uTotal"></td>
          </tr>
          <tr id="bot-score-row">
            <td>ğŸ¤–</td>
            <td id="b0"></td><td id="b1"></td><td id="b2"></td><td id="b3"></td><td id="b4"></td>
            <td id="b5"></td><td id="b6"></td><td id="b7"></td><td id="b8"></td>
            <td id="bTotal"></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="d-flex justify-content-between">
        <!-- ì™¼ìª½: ìœ ì € ë¼ì¸ì—… -->
        <div id="user-lineup-box"
             class="position-relative"
             style="width: 1000px; height: 600px; margin-top: 10px; overflow: visible;"></div>
             
        <!-- ì¤‘ê³„ í…ìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="play-by-play-wrapper mx-5">
           <h5 class="text-white">ğŸ“º ì¤‘ê³„ ë°©ì†¡</h5>
          <div id="play-by-play"></div>
        </div>
        
        <!-- ì˜¤ë¥¸ìª½: ë´‡ ë¼ì¸ì—… -->
        <div id="bot-lineup-box"
             class="position-relative"
             style="width: 1000px; height: 600px; margin-top: 10px; overflow: visible;"></div>
    </div>
    
    <!-- ê²½ê¸°ì¥ ì˜ì—­ (ë¼ì¸ì—… + ë£¨ + ì£¼ì) -->
    <div id="field" class="d-flex justify-content-center align-items-top">
      
      <!-- ì¤‘ì•™: ì•¼êµ¬ì¥ êµ¬ì„± -->
      <div id="stadium" class="position-relative" style="width: 400px; height: 400px;">
        <!-- ë£¨ ìœ„ì¹˜ -->
        <div id="base-home" class="base-point" style="top: -30%; left: 43%;">
            <img src="/static/game/home.png" width="35"/>
        </div>
        <div id="base-1" class="base-point" style="top: -65%; left: 86%;">
            <img src="/static/game/base.png" width="35"/>
        </div>
        <div id="base-2" class="base-point" style="top: -100%; left: 43%;">
            <img src="/static/game/base.png" width="35"/>
        </div>
        <div id="base-3" class="base-point" style="top: -65%; left:0%;">
            <img src="/static/game/base.png" width="35"/>
        </div>

        <!-- ìœ ì € íŒ€ ì£¼ì -->
		<div id="runner-1" class="runner-icon" style="display:none;">ğŸ§â€â™‚ï¸</div>
		<div id="runner-2" class="runner-icon" style="display:none;">ğŸƒâ€â™‚ï¸</div>
		<div id="runner-3" class="runner-icon" style="display:none;">ğŸƒ</div>
		<div id="runner-4" class="runner-icon" style="display:none;">ğŸ§â€â™‚ï¸</div>
        <div id="runner-5" class="runner-icon" style="display:none;">ğŸƒâ€â™‚ï¸</div>
        <div id="runner-6" class="runner-icon" style="display:none;">ğŸƒ</div>
		
		<!-- ë´‡ íŒ€ ì£¼ì -->
		<div id="bot-runner-1" class="runner-icon" style="display:none;">ğŸ¤–</div>
		<div id="bot-runner-2" class="runner-icon" style="display:none;">ğŸ‘¾</div>
		<div id="bot-runner-3" class="runner-icon" style="display:none;">ğŸ›¸</div>
      </div>

      
     </div>
    <!-- ë¬¸ì œ ì¶œì œ ëª¨ë‹¬ -->
	<div class="modal fade" id="eventQuestionModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content text-dark">
	      <div class="modal-header">
	        <h5 class="modal-title">âš¾ ì„ íƒ ì´ë²¤íŠ¸</h5>
	      </div>
	      <div class="modal-body">
	        <p id="event-question-text"></p>
	        <div id="event-choice-buttons" class="d-grid gap-2 mt-3"></div>
	      </div>
	    </div>
	  </div>
	</div>
  </div>
</th:block>

<th:block layout:fragment="script">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
  crossorigin="anonymous"></script>
<script th:inline="javascript">
    const difficulty = '[[${difficulty}]]';
</script>
<script>
	//ê²½ê¸° ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
	let baseState = [null, null, null];
	let botBaseState = [null, null, null];
	let runnerCounter = 1;
	let botRunnerCounter = 1;
	let userLineup = [];
	let botLineup = [];
	let gameQuestions = [];     // 5ë¬¸ì œ ì €ì¥
	let questionIndex = 0;      // í˜„ì¬ê¹Œì§€ ë³´ì—¬ì¤€ ë¬¸ì œ ìˆ˜
	let isPaused = false;      // ê²½ê¸° ì¼ì‹œì •ì§€
	
	const overlay = document.querySelector('.overlay');
	const scheduleId = overlay.getAttribute('data-schedule-id');
	const userId = overlay.getAttribute('data-user-id');
	
	// ê²Œì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ
	const startBtn = document.getElementById('start-game-btn');
	startBtn.addEventListener('click', startGameAndLoadLineups);
	
	// ê²Œì„ ì‹œì‘ ìš”ì²­ ë° ë¼ì¸ì—… ë¶ˆëŸ¬ì˜¤ê¸°
	function startGameAndLoadLineups() {
	  $.ajax({
	    url: '/game/lineup',
	    type: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({ userId: userId, difficulty: difficulty }),
	    success: function (data) {
	      userLineup = data.userLineup;
	      botLineup = data.botLineup;
	      const gameResult = data.results;
	
	      renderLineup(userLineup, 'user-lineup-box');
	      renderLineup(botLineup, 'bot-lineup-box', true);
	      runSimulation(gameResult);
	    }
	  });
	  
	  //5ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
	  $.get("/game/game-event/questions", function(questions) {
		  gameQuestions = questions;
		});
	}
	
	document.getElementById('start-game-btn').addEventListener('click', function () {
	  const buttonArea = document.getElementById('game-button-area');

	  // ê¸°ì¡´ ì‹œì‘ ë²„íŠ¼ ì œê±°
	  buttonArea.innerHTML = '';

	  // ì¼ì‹œì •ì§€ ë²„íŠ¼
	  const pauseBtn = document.createElement('button');
	  pauseBtn.className = 'btn btn-danger fw-bold me-2';
	  pauseBtn.innerText = 'â¸ ê²Œì„ ì¼ì‹œì •ì§€';
	  pauseBtn.onclick = function () {
	    isPaused = true;
	  };

	  // ë¼ì¸ì—… êµ¬ì„± ë²„íŠ¼
	  const lineupBtn = document.createElement('button');
	  lineupBtn.className = 'btn btn-secondary fw-bold me-2';
	  lineupBtn.innerText = 'ğŸ§¾ ë¼ì¸ì—… êµ¬ì„±í•˜ëŸ¬ê°€ê¸°';
	  lineupBtn.onclick = function () {
	    window.location.href = '/game/ready-view';
	  };

	  // ê²°ê³¼ë³´ê¸° ë²„íŠ¼
	  const resultBtn = document.createElement('button');
		resultBtn.className = 'btn btn-success fw-bold';
		resultBtn.innerText = 'ğŸ“Š ê²Œì„ ê²°ê³¼ë³´ê¸°';
		resultBtn.onclick = function () {
		  if (scheduleId && userId) {
		    window.location.href = `/game/result-view?scheduleId=${scheduleId}&userId=${userId}`;
		  } else {
		    alert('ê²Œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
		  }
		};

	  // ë²„íŠ¼ ì¶”ê°€
	  buttonArea.appendChild(pauseBtn);
	  buttonArea.appendChild(lineupBtn);
	  buttonArea.appendChild(resultBtn);
	});
	
	// ë¼ì¸ì—… ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ (ê¸°ë³¸ ë˜ëŠ” ë´‡ ì—¬ë¶€ êµ¬ë¶„)
	function renderLineup(lineup, targetId, isBot) {
	  const container = document.getElementById(targetId);
	  container.innerHTML = '';

	  const positionOrder = {
	    'C': 1, '1B': 2, '2B': 3, '3B': 4, 'SS': 5,
	    'LF': 6, 'CF': 7, 'RF': 8, 'DH': 9, 'P': 10
	  };

	  lineup.sort(function (a, b) {
	    const aOrder = positionOrder[a.position] || 99;
	    const bOrder = positionOrder[b.position] || 99;
	    return aOrder - bOrder;
	  });

	  for (let i = 0; i < lineup.length; i++) {
	    const card = lineup[i];
	    const div = document.createElement('div');
	    div.className = 'card-mini text-center bg-light border rounded position-absolute p-1';
	    div.innerHTML =
	      '<div class="fw-bold">' + card.playerName + '</div>' +
	      '<div>' + card.position + '</div>' +
	      '<div class="text-muted">' + card.grade + 'ë“±ê¸‰</div>';

	    div.style.top = (i * 70) + 'px';
	    div.style.left = (i * 30) + 'px';
	    if (isBot) {
	      div.style.left = 'auto';
	      div.style.right = (i * 30) + 'px';
	    }

	    container.appendChild(div);
	  }
	}
	
	// ì£¼ì ìƒíƒœ ì´ˆê¸°í™”
	function resetRunners() {
	  for (let i = 1; i <= 3; i++) {
	    hideRunner('runner-' + i);
	    hideRunner('bot-runner-' + i);
	  }
	  baseState = [null, null, null];
	  botBaseState = [null, null, null];
	  runnerCounter = 1;
	  botRunnerCounter = 1;
	}
	
	// ì£¼ì ìˆ¨ê¸°ê¸°
	function hideRunner(runnerId) {
	  const runner = document.getElementById(runnerId);
	  if (runner) runner.style.display = 'none';
	}
	
	// ì£¼ì ë“ì  ì²˜ë¦¬
	function scoreRun(runnerId) {
	  moveRunnerTo('base-home', runnerId);
	  setTimeout(function () {
	    hideRunner(runnerId);
	  }, 900);
	}
	
	// ì£¼ì ID ìƒì„± ë° í‘œì‹œ
	function getNextRunnerId(team) {
	  let id;
	  if (team === 'bot') {
	    id = 'bot-runner-' + botRunnerCounter;
	    botRunnerCounter++;
	  } else {
	    id = 'runner-' + runnerCounter;
	    runnerCounter++;
	  }
	
	  const runnerDiv = document.getElementById(id);
	  if (runnerDiv) {
	    runnerDiv.style.display = 'block';
	    return id;
	  }
	  return null;
	}
	
	// ì£¼ì ì´ë™ ì²˜ë¦¬
	function moveRunnerTo(baseId, runnerId) {
	  const base = document.getElementById(baseId);
	  const runner = document.getElementById(runnerId);
	  const stadium = document.getElementById('stadium');
	  if (!base || !runner || !stadium) return;
	
	  const rect = base.getBoundingClientRect();
	  const stadiumRect = stadium.getBoundingClientRect();
	
	  const left = rect.left - stadiumRect.left + rect.width / 2;
	  const top = rect.top - stadiumRect.top + rect.height / 2;
	
	  runner.style.left = left + 'px';
	  runner.style.top = top + 'px';
	  runner.style.display = 'block';
	}
	
	// íƒ€ì ì´ë¦„ ì¹˜í™˜
	function replaceBatterName(playText, lineup) {
	  const match = playText.match(/^([0-9]+)ë²ˆ íƒ€ì: (.+)$/);
	  if (!match) return playText;
	
	  const batterIndex = parseInt(match[1], 10) - 1;
	  const playerName = (lineup[batterIndex] && lineup[batterIndex].playerName) || '???';
	  return playerName + ': ' + match[2];
	}
	
	// ê²½ê¸° ë¡œê·¸ ì¶œë ¥
	function logPlayByPlay(message) {
	  const container = document.getElementById('play-by-play');
	  const line = document.createElement('p');
	  line.innerText = message;
	  container.appendChild(line);
	  container.scrollTop = container.scrollHeight;
	}
	
	// ê²½ê¸° ë¡œê·¸ ë° AI í•´ì„¤ ì¶œë ¥
	function logPlayByPlayWithAI(play) {
	  const parts = play.split(': ');
	  const result = parts.length > 1 ? parts[1] : '';
	  const comment = getAiComment(result);
	
	  let message = play;
	  if (comment) message += ' ' + comment;
	
	  logPlayByPlay(message);
	}
	
	// ê²°ê³¼ ê¸°ë°˜ AI í•´ì„¤ í…ìŠ¤íŠ¸ ë°˜í™˜
	function getAiComment(result) {
      const comments = {
        'ì•ˆíƒ€': [
          'âš¾ ìœ ê²©ìˆ˜ ì˜†ì„ í†µê³¼í•˜ëŠ” ì•ˆíƒ€!',
          'ğŸ§¢ ë¹ ë¥¸ íƒ€êµ¬ê°€ ì™¸ì•¼ë¡œ!',
          'ğŸ”” ê¹¨ë—í•œ ì¤‘ì „ ì•ˆíƒ€!',
          'ğŸ¯ íƒ€ì´ë° ì™„ë²½í•œ ì•ˆíƒ€!'
        ],
        '2ë£¨íƒ€': [
          'ğŸ’¥ ê¹Šìˆ™í•œ 2ë£¨íƒ€!',
          'ğŸ“¦ ì™¸ì•¼ìˆ˜ ì‚¬ì´ë¥¼ ëš«ì—ˆìŠµë‹ˆë‹¤!',
          'ğŸš€ ë¹ ë¥´ê²Œ 2ë£¨ê¹Œì§€ ë„ë‹¬!',
          'ğŸ’ª íŒŒì›Œ ìˆëŠ” íƒ€êµ¬, 2ë£¨íƒ€!'
        ],
        '3ë£¨íƒ€': [
          'ğŸ”¥ ì§ˆì£¼í•˜ëŠ” 3ë£¨íƒ€!',
          'ğŸ¢ ì¥íƒ€! ì£¼ì 3ë£¨ê¹Œì§€!',
          'ğŸ’¨ ì™¸ì•¼ êµ¬ì„ê¹Œì§€ êµ´ëŸ¬ê°‘ë‹ˆë‹¤!',
          'ğŸŒªï¸ ìŠ¬ë¼ì´ë”©ìœ¼ë¡œ 3ë£¨ ë„ì°©!'
        ],
        'í™ˆëŸ°': [
          'ğŸ’£ ë‹´ì¥ì„ ë„˜ê²¼ìŠµë‹ˆë‹¤!',
          'ğŸ‰ ëŒ€í˜• í™ˆëŸ°! íŒ¬ë“¤ ì—´ê´‘!',
          'ğŸ§¨ ì¤‘ê²¬ìˆ˜ ë„˜ì–´ê°€ëŠ” ë¹„ê±°ë¦¬!',
          'âš¡ ì´ê²ƒì´ í™ˆëŸ°ì…ë‹ˆë‹¤!'
        ],
        'ë³¼ë„·': [
          'âš¾ ë³¼ë„· ì¶œë£¨!',
          'ğŸ™„ ì œêµ¬ ë‚œì¡°! 1ë£¨ë¡œ ì¶œë£¨í•©ë‹ˆë‹¤.',
          'ğŸ§ ìŠ¤íŠ¸ë¼ì´í¬ ì¡´ì„ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.',
          'ğŸ§  ì¹¨ì°©í•˜ê²Œ ë³¼ë„·ì„ ì–»ì–´ëƒ…ë‹ˆë‹¤.'
        ],
        'ì‚¼ì§„': [
          'ğŸ’¨ í—›ìŠ¤ìœ™ ì‚¼ì§„!',
          'ğŸ˜“ ë³€í™”êµ¬ì— ì†ì•˜ìŠµë‹ˆë‹¤.',
          'âš”ï¸ ë£¨í‚¹ ì‚¼ì§„! ì›€ì§ì´ì§€ ëª»í–ˆì–´ìš”.',
          'ğŸŒ€ ì™„ë²½í•œ ì‚¼ì§„ ì²˜ë¦¬!'
        ],
        'ì•„ì›ƒ': [
          'ğŸ§¤ í‰ë²”í•œ ë‚´ì•¼ ë•…ë³¼ ì•„ì›ƒ!',
          'ğŸªƒ ëœ¬ê³µ! ì¡í˜”ìŠµë‹ˆë‹¤.',
          'ğŸ§Š íƒ€ì´ë°ì´ ëŠ¦ì—ˆìŠµë‹ˆë‹¤, ì•„ì›ƒ!',
          'ğŸ”’ ìˆ˜ë¹„ê°€ ì¹¨ì°©í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.'
        ],
        'ë³‘ì‚´': [
          'ğŸ˜± ë³‘ì‚´! ì°¬ìŠ¤ë¥¼ ë†“ì¹©ë‹ˆë‹¤.',
          'ğŸ§± ë³‘ì‚´íƒ€! ê³µê²© íë¦„ì´ ëŠê¹ë‹ˆë‹¤.',
          'ğŸ˜– ì•„ì‰¬ìš´ ë³‘ì‚´ í”Œë ˆì´!',
          'â˜ ï¸ ë‘ ëª…ì´ ë™ì‹œì— ì•„ì›ƒë©ë‹ˆë‹¤!'
        ]
      };
	
	  const options = comments[result];
	  if (!options) return '';
	  const index = Math.floor(Math.random() * options.length);
	  return options[index];
	}
	
	// í”Œë ˆì´ ë©”ì‹œì§€ ì¶œë ¥ê³¼ ë”œë ˆì´ ì¡°ì ˆ
	function delayAndLog(playMessage) {
	  return new Promise(function (resolve) {
	    const container = document.getElementById('play-by-play');
	    const parts = playMessage.split(': ');
	    const result = parts.length > 1 ? parts[1] : '';
	    const comment = getAiComment(result);
	
	    const line = document.createElement('p');
	    line.innerText = comment ? playMessage + ' ' + comment : playMessage;
	    container.appendChild(line);
	    container.scrollTop = container.scrollHeight;
	
	    let delayTime = 2000;
	    if (result === 'í™ˆëŸ°') delayTime = 6000;
	    else if (result === '2ë£¨íƒ€' || result === '3ë£¨íƒ€') delayTime = 4000;
	    else if (result === 'ì•ˆíƒ€' || result === 'ë³¼ë„·') delayTime = 3000;
	
	    setTimeout(resolve, delayTime);
	  });
	}
	
	// ì´ë‹ ì‚¬ì´ ì§§ì€ ë”œë ˆì´
	function delayInningBreak() {
	  return new Promise(function (resolve) {
	    setTimeout(resolve, 1000);
	  });
	}
	
	// ì ìˆ˜íŒ ì—…ë°ì´íŠ¸
	function updateScoreBoard(inningIndex, userScore, botScore) {
	  const userCell = document.getElementById('u' + inningIndex);
	  const botCell = document.getElementById('b' + inningIndex);
	  if (userCell) userCell.innerText = userScore;
	  if (botCell) botCell.innerText = botScore;
	
	  let uSum = 0;
	  let bSum = 0;
	  for (let i = 0; i <= inningIndex; i++) {
	    const u = parseInt(document.getElementById('u' + i)?.innerText || 0);
	    const b = parseInt(document.getElementById('b' + i)?.innerText || 0);
	    uSum += u;
	    bSum += b;
	  }
	  document.getElementById('uTotal').innerText = uSum;
	  document.getElementById('bTotal').innerText = bSum;
	}
	
	// ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ë° ì§„í–‰
	async function runSimulation(gameResult) {
	  let userSum = 0;
	  let botSum = 0;
	  for (let i = 0; i < gameResult.length; i++) {
	    const inning = gameResult[i];
	
	    // --- ì´ë‹ ì‹œì‘ ì‹œ ë¬¸ì œ ì¶œì œ ì¡°ê±´
	    if ([0, 2, 4, 6, 8].includes(i) && questionIndex < gameQuestions.length) {
	      const q = gameQuestions[questionIndex];
	      const isPitch = q.eventType === 'pitch';
	      const isBatting = q.eventType === 'batting';
	      const isRandom = q.eventType === 'coach' || q.eventType === 'defense';
	
	      if (isBatting || (isRandom && Math.random() < 0.5)) {
	        await new Promise(resolve => {
	          showEventQuestion(q);
	          const interval = setInterval(() => {
	            if (!$('#eventQuestionModal').hasClass('show')) {
	              clearInterval(interval);
	              resolve();
	            }
	          }, 100);
	        });
	        await waitIfPaused();
	        questionIndex++;
	      }
	    }
	
	    // ìœ ì € ê³µê²©
	    resetRunners();
	    for (let j = 0; j < inning.userPlays.length; j++) {
	      const play = inning.userPlays[j];
	      const replaced = replaceBatterName(play, userLineup);
	      handlePlayResult(replaced.split(': ')[1], 'user');
	      await delayAndLog(replaced);
	    }
	    userSum += inning.userScore;
	    updateScoreBoard(i, inning.userScore, 0);
	    logPlayByPlay(`${i + 1}íšŒì´ˆ ì¢…ë£Œ  ğŸ§‘ ${userSum} : ğŸ¤– ${botSum}`);
	    await delayInningBreak();
	
	    // --- pitch ë˜ëŠ” ëœë¤ ë¬¸ì œ
	    if ([0, 2, 4, 6, 8].includes(i) && questionIndex < gameQuestions.length) {
	      const q = gameQuestions[questionIndex];
	      const isPitch = q.eventType === 'pitch';
	      const isRandom = q.eventType === 'coach' || q.eventType === 'defense';
	
	      if (isPitch || (isRandom && Math.random() < 0.5)) {
	        await new Promise(resolve => {
	          showEventQuestion(q);
	          const interval = setInterval(() => {
	            if (!$('#eventQuestionModal').hasClass('show')) {
	              clearInterval(interval);
	              resolve();
	            }
	          }, 100);
	        });
	        await waitIfPaused();
	        questionIndex++;
	      }
	    }
	
	    // ë´‡ ê³µê²©
	    resetRunners();
	    for (let j = 0; j < inning.botPlays.length; j++) {
	      const play = inning.botPlays[j];
	      const replaced = replaceBatterName(play, botLineup);
	      handlePlayResult(replaced.split(': ')[1], 'bot');
	      await delayAndLog(replaced);
	    }
	    botSum += inning.botScore;
	    updateScoreBoard(i, inning.userScore, inning.botScore);
	    logPlayByPlay(`${i + 1}íšŒë§ ì¢…ë£Œ ğŸ§‘ ${userSum} : ğŸ¤– ${botSum}`);
	    await delayInningBreak();
	  }
	
	  await delayAndLog('ê²½ê¸° ì¢…ë£Œ');
	}
	
	// ê° ìƒí™©ë³„ ì£¼ì ì²˜ë¦¬
	function handlePlayResult(result, team) {
	  const state = (team === 'bot') ? botBaseState : baseState;
	
	  if (result === 'ì•ˆíƒ€') {
	    if (state[2]) scoreRun(state[2]);
	    if (state[1]) moveRunnerTo('base-3', state[1]);
	    state[2] = state[1];
	    if (state[0]) moveRunnerTo('base-2', state[0]);
	    state[1] = state[0];
	    const newRunner = getNextRunnerId(team);
	    if (newRunner) moveRunnerTo('base-1', newRunner);
	    state[0] = newRunner;
	  } else if (result === '2ë£¨íƒ€') {
	    if (state[2]) scoreRun(state[2]);
	    if (state[1]) scoreRun(state[1]);
	    if (state[0]) moveRunnerTo('base-3', state[0]);
	    state[2] = state[0];
	    const newRunner = getNextRunnerId(team);
	    if (newRunner) moveRunnerTo('base-2', newRunner);
	    state[1] = newRunner;
	    state[0] = null;
	  } else if (result === '3ë£¨íƒ€') {
	    for (let i = 0; i < 3; i++) {
	      if (state[i]) scoreRun(state[i]);
	    }
	    const newRunner = getNextRunnerId(team);
	    if (newRunner) moveRunnerTo('base-3', newRunner);
	    state[0] = null;
	    state[1] = null;
	    state[2] = newRunner;
	  } else if (result === 'í™ˆëŸ°') {
	    for (let i = 0; i < 3; i++) {
	      if (state[i]) scoreRun(state[i]);
	    }
	    const newRunner = getNextRunnerId(team);
	    if (newRunner) {
	      moveRunnerTo('base-1', newRunner);
	      setTimeout(function () {
	        moveRunnerTo('base-2', newRunner);
	      }, 500);
	      setTimeout(function () {
	        moveRunnerTo('base-3', newRunner);
	      }, 1000);
	      setTimeout(function () {
	        scoreRun(newRunner);
	      }, 1500);
	    }
	    state[0] = null;
	    state[1] = null;
	    state[2] = null;
	  } else if (result === 'ë³¼ë„·') {
	    if (state[2]) scoreRun(state[2]);
	    if (state[1]) moveRunnerTo('base-3', state[1]);
	    state[2] = state[1];
	    if (state[0]) moveRunnerTo('base-2', state[0]);
	    state[1] = state[0];
	    const newRunner = getNextRunnerId(team);
	    if (newRunner) moveRunnerTo('base-1', newRunner);
	    state[0] = newRunner;
	  } else if (result === 'ë³‘ì‚´') {
	    if (state[0]) hideRunner(state[0]);
	    state[0] = null;
	  }
	}
    
	// ë‹µì•ˆ ì €ì¥
	function saveEventAnswer(questionId, choiceId, choiceText) {
	  $.ajax({
	    url: '/game/game-event/answer',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({
	      scheduleId: scheduleId,   // ì „ì—­ ë³€ìˆ˜ë¡œ ë°›ì•„ë‘¬ì•¼ í•¨
	      questionId: questionId,
	      answerText: choiceText
	    })
	  });
	}
	
	// ë¬¸ì œ í‘œì‹œ ëª¨ë‹¬ í•¨ìˆ˜
	function showEventQuestion(question) {
	  isPaused = true;
	
	  const modalElement = document.getElementById('eventQuestionModal');
	  const modal = new bootstrap.Modal(modalElement);
	  document.getElementById('event-question-text').innerText = question.questionText;
	
	  const choicesBox = document.getElementById('event-choice-buttons');
	  choicesBox.innerHTML = '';
	
	  const choices = [];
	  if (question.choice1) choices.push(question.choice1);
	  if (question.choice2) choices.push(question.choice2);
	  if (question.choice3) choices.push(question.choice3);
	  if (question.choice4) choices.push(question.choice4);
	
	  for (let i = 0; i < choices.length; i++) {
	    const choiceText = choices[i];
	    const btn = document.createElement('button');
	    btn.className = 'btn btn-outline-primary m-1';
	    btn.innerText = choiceText;
	    btn.onclick = function () {
	      saveEventAnswer(question.id, null, choiceText);
	      modal.hide();
	      document.activeElement.blur();
	      isPaused = false;
	    };
	    choicesBox.appendChild(btn);
	  }
	
	  modal.show();
	}
	
	//ì¼ì‹œì •ì§€
	async function waitIfPaused() {
	  while (isPaused) {
	    await new Promise(function(resolve) {
	      setTimeout(resolve, 100);
	    });
	  }
	}
	
</script>
</th:block>
</html>
